<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat Online + TikTok Viewer</title>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Vazirmatn',sans-serif;background:#f0f2f5;color:#333;}
.hidden{display:none;}
#auth, #main{padding:20px;}
input, button{padding:10px;margin:5px;border-radius:5px;border:1px solid #ccc;}
button{cursor:pointer;background:#ff2e63;color:#fff;border:none;}
button:hover{background:#ff1b45;}
#tabs{display:flex;margin-bottom:10px;}
#tabs button{flex:1;}
#tabs button.active{background:#ff2e63;color:white;}
#content{display:flex;gap:10px;}
#video-section, #chat-section{flex:1;border:1px solid #ccc;padding:10px;border-radius:10px;overflow-y:auto;max-height:80vh;}
.video-item{margin-bottom:10px;}
.video-item iframe{width:100%;height:300px;border-radius:10px;}
#user-list div{padding:8px;margin:5px;background:#08d9d6;color:white;border-radius:10px;cursor:pointer;}
#user-list div:hover{background:#06c0b0;}
#chat-box{border:1px solid #ccc;padding:10px;height:400px;overflow-y:auto;background:#fff;border-radius:10px;margin-bottom:10px;}
.message{margin-bottom:10px;padding:8px;border-radius:10px;max-width:70%;word-wrap:break-word;}
.message.sent{background:#08d9d6;color:white;margin-left:auto;}
.message.received{background:#ff2e63;color:white;margin-right:auto;}
#chat-input{display:flex;gap:5px;}
</style>
</head>
<body>

<div id="auth">
  <h2>Chat Online + TikTok</h2>
  <input type="text" id="username" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ">
  <input type="password" id="password" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
  <div>
    <button id="registerBtn">Ø«Ø¨Øª Ù†Ø§Ù…</button>
    <button id="loginBtn">ÙˆØ±ÙˆØ¯</button>
  </div>
  <p id="auth-msg" style="color:red;"></p>
</div>

<div id="main" class="hidden">
  <div id="tabs">
    <button id="tab-videos" class="active">ÙˆÛŒØ¯Ø¦ÙˆÙ‡Ø§ÛŒ TikTok</button>
    <button id="tab-chat">Ú†Øª Ø¢Ù†Ù„Ø§ÛŒÙ†</button>
  </div>
  <div id="content">
    <div id="video-section"></div>
    <div id="chat-section" class="hidden">
      <div id="user-list"></div>
      <div id="chat-box"></div>
      <div id="chat-input">
        <input type="text" id="msgInput" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯">
        <button id="sendMsgBtn">Ø§Ø±Ø³Ø§Ù„ Ù…ØªÙ†</button>
        <button id="sendImgBtn">ðŸ“·</button>
        <button id="sendAudioBtn">ðŸŽ¤</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, set, push, onChildAdded, onValue } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyDn86gjV3Ena3Q4i84rCGNnnGTyDqEE2Xg",
  authDomain: "ams1-949e7.firebaseapp.com",
  databaseURL: "https://ams1-949e7-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "ams1-949e7",
  storageBucket: "ams1-949e7.firebasestorage.app",
  messagingSenderId: "1061973812134",
  appId: "1:1061973814:web:94e44e9931b5ae9f3d2567",
  measurementId: "G-HDJ81BTE70"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getDatabase();

const usernameInput = document.getElementById("username");
const passwordInput = document.getElementById("password");
const authMsg = document.getElementById("auth-msg");
const mainDiv = document.getElementById("main");
const authDiv = document.getElementById("auth");
const tabVideos = document.getElementById("tab-videos");
const tabChat = document.getElementById("tab-chat");
const videoSection = document.getElementById("video-section");
const chatSection = document.getElementById("chat-section");
const userListDiv = document.getElementById("user-list");
const chatBox = document.getElementById("chat-box");
const msgInput = document.getElementById("msgInput");
const sendMsgBtn = document.getElementById("sendMsgBtn");
const sendImgBtn = document.getElementById("sendImgBtn");
const sendAudioBtn = document.getElementById("sendAudioBtn");

let currentUser = null;
let currentChatUser = null;

// Ø«Ø¨Øª Ù†Ø§Ù…
document.getElementById("registerBtn").onclick = ()=>{
  const username = usernameInput.value.trim();
  const password = passwordInput.value.trim();
  if(!username || !password){ authMsg.textContent="Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯"; return;}
  const email = username+"@chatapp.fake";
  createUserWithEmailAndPassword(auth,email,password)
  .then(userCredential=>{
    set(ref(db,"users/"+userCredential.user.uid),{username:username,online:true});
    authMsg.style.color="green"; authMsg.textContent="Ø«Ø¨Øª Ù†Ø§Ù… Ù…ÙˆÙÙ‚! ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯";
  })
  .catch(error=>{ authMsg.style.color="red"; authMsg.textContent=error.message; });
};

// ÙˆØ±ÙˆØ¯
document.getElementById("loginBtn").onclick = ()=>{
  const username = usernameInput.value.trim();
  const password = passwordInput.value.trim();
  if(!username || !password){ authMsg.textContent="Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯"; return;}
  const email = username+"@chatapp.fake";
  signInWithEmailAndPassword(auth,email,password)
  .catch(error=>{ authMsg.style.color="red"; authMsg.textContent=error.message; });
};

// ÙˆØ¶Ø¹ÛŒØª ÙˆØ±ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø±
onAuthStateChanged(auth,user=>{
  if(user){
    currentUser=user.uid;
    set(ref(db,"users/"+currentUser+"/online"),true);
    authDiv.classList.add("hidden");
    mainDiv.classList.remove("hidden");
    loadUsers();
    loadVideos();
  } else {
    authDiv.classList.remove("hidden");
    mainDiv.classList.add("hidden");
  }
});

// Ù„ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ†
function loadUsers(){
  onValue(ref(db,"users"),snapshot=>{
    userListDiv.innerHTML="";
    snapshot.forEach(s=>{
      const u = s.val();
      if(s.key===currentUser) return;
      const div = document.createElement("div");
      div.textContent = u.username;
      div.onclick = ()=>{
        currentChatUser = s.key;
        chatBox.innerHTML="";
        listenChat(currentUser,currentChatUser);
      };
      userListDiv.appendChild(div);
    });
  });
}

// Ù„ÙˆØ¯ Ú†Øª Ø¢Ù†Ù„Ø§ÛŒÙ†
function listenChat(me,other){
  const chatId = [me,other].sort().join("_");
  const chatRef = ref(db,"chats/"+chatId);
  onChildAdded(chatRef,snap=>{
    const msg = snap.val();
    const div = document.createElement("div");
    div.className="message "+(msg.sender===me?"sent":"received");
    if(msg.type==="text"){ div.textContent=msg.text; }
    if(msg.type==="image"){ div.innerHTML=`<img src="${msg.text}" style="max-width:100%;border-radius:10px;">`; }
    if(msg.type==="audio"){ div.innerHTML=`<audio controls src="${msg.text}" style="width:100%;"></audio>`; }
    chatBox.appendChild(div);
    chatBox.scrollTop=chatBox.scrollHeight;
  });
}

// Ø§Ø±Ø³Ø§Ù„ Ù…ØªÙ†
sendMsgBtn.onclick = ()=>{
  if(!currentChatUser){ alert("Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ú©Ø§Ø±Ø¨Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯"); return;}
  const text = msgInput.value.trim();
  if(!text) return;
  sendMessage(currentUser,currentChatUser,text,"text");
  msgInput.value="";
};

// Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³
sendImgBtn.onclick = ()=>{
  if(!currentChatUser){ alert("Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ú©Ø§Ø±Ø¨Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯"); return;}
  const fi = document.createElement("input");
  fi.type="file"; fi.accept="image/*";
  fi.onchange = ()=>{
    const file = fi.files[0];
    const reader = new FileReader();
    reader.onload = ()=>{ sendMessage(currentUser,currentChatUser,reader.result,"image"); };
    reader.readAsDataURL(file);
  };
  fi.click();
};

// Ø§Ø±Ø³Ø§Ù„ ØµØ¯Ø§
sendAudioBtn.onclick = ()=>{
  if(!currentChatUser){ alert("Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ú©Ø§Ø±Ø¨Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯"); return;}
  if(!navigator.mediaDevices || !window.MediaRecorder){ alert("Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² Ø¶Ø¨Ø· ØµØ¯Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯"); return; }
  navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
    const mediaRecorder = new MediaRecorder(stream);
    let chunks=[];
    mediaRecorder.ondataavailable=e=>{ chunks.push(e.data); };
    mediaRecorder.onstop=e=>{
      const blob = new Blob(chunks,{type:'audio/webm'});
      const url = URL.createObjectURL(blob);
      sendMessage(currentUser,currentChatUser,url,"audio");
      chunks=[];
    };
    mediaRecorder.start();
    alert("Ø¶Ø¨Ø· Ø¢ØºØ§Ø² Ø´Ø¯ØŒ Ù¾Ø³ Ø§Ø² Ù¾Ø§ÛŒØ§Ù† OK Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.");
    setTimeout(()=>{ mediaRecorder.stop(); stream.getTracks().forEach(t=>t.stop()); },5000);
  });
};

// Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…
function sendMessage(me,other,text,type){
  const chatId = [me,other].sort().join("_");
  push(ref(db,"chats/"+chatId),{sender:me,text,type});
}

// Ù†Ù…Ø§ÛŒØ´ ÙˆÛŒØ¯Ø¦ÙˆÙ‡Ø§ÛŒ TikTok
function loadVideos(){
  const videos = [
    "https://www.tiktok.com/embed/7255031982033485099",
    "https://www.tiktok.com/embed/7255031982033485100"
  ];
  videoSection.innerHTML="";
  videos.forEach(v=>{
    const div = document.createElement("div");
    div.className="video-item";
    div.innerHTML=`<iframe src="${v}" frameborder="0" allowfullscreen></iframe>`;
    videoSection.appendChild(div);
  });
}

// ØªØ¨â€ŒÙ‡Ø§
tabVideos.onclick=()=>{
  tabVideos.classList.add("active"); tabChat.classList.remove("active");
  videoSection.style.display="block"; chatSection.style.display="none";
};
tabChat.onclick=()=>{
  tabChat.classList.add("active"); tabVideos.classList.remove("active");
  videoSection.style.display="none"; chatSection.style.display="block";
};
</script>

</body>
</html> 
