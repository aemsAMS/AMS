<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ú†Øª Ø¢Ù†Ù„Ø§ÛŒÙ† Ø¨Ø§ Firebase</title>
<style>
body{font-family:sans-serif;background:#f0f0f0;margin:0;padding:0;display:flex;flex-direction:column;height:100vh;}
.hidden{display:none;}
#auth,#chat-container{margin:auto;width:95%;max-width:600px;}
#auth input,#auth button,#chat-input input,#chat-input button{padding:10px;margin:5px;border-radius:5px;border:1px solid #ccc;}
#auth button,#chat-input button{border:none;background:#2196F3;color:white;cursor:pointer;}
#chat-box{height:400px;overflow-y:auto;background:white;padding:10px;border-radius:5px;border:1px solid #ccc;margin-bottom:10px;}
.message{padding:8px 10px;border-radius:10px;margin:5px 0;max-width:70%;}
.sent{background:#4CAF50;color:white;margin-left:auto;}
.received{background:#2196F3;color:white;margin-right:auto;}
#user-list{display:flex;overflow-x:auto;margin-bottom:10px;}
#user-list div{padding:8px 12px;background:#ff5722;color:white;border-radius:20px;margin-right:5px;cursor:pointer;white-space:nowrap;}
#chat-input{display:flex;}
#video-section{margin-top:20px;}
.video-item{margin-bottom:10px;}
.video-item iframe{width:100%;height:250px;border-radius:10px;}
</style>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
</head>
<body>

<!-- Auth -->
<div id="auth">
  <h2>Ø«Ø¨Øª Ù†Ø§Ù… / ÙˆØ±ÙˆØ¯</h2>
  <input type="text" id="username" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ">
  <input type="password" id="password" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
  <button id="registerBtn">Ø«Ø¨Øª Ù†Ø§Ù…</button>
  <button id="loginBtn">ÙˆØ±ÙˆØ¯</button>
  <p id="auth-msg"></p>
</div>

<!-- Chat -->
<div id="chat-container" class="hidden">
  <h3>Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ†</h3>
  <div id="user-list"></div>
  <div id="chat-box"></div>
  <div id="chat-input">
    <input type="text" id="msgInput" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯">
    <button id="sendBtn">Ø§Ø±Ø³Ø§Ù„</button>
    <button id="sendImgBtn">ğŸ“·</button>
    <button id="sendAudioBtn">ğŸ¤</button>
  </div>
  
  <h3>ÙˆÛŒØ¯Ø¦ÙˆÙ‡Ø§ÛŒ TikTok</h3>
  <div id="video-section"></div>
  <input type="text" id="videoLinkInput" placeholder="Ù„ÛŒÙ†Ú© ÙˆÛŒØ¯Ø¦Ùˆ TikTok">
  <button id="addVideoBtn">Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙˆÛŒØ¯Ø¦Ùˆ</button>
</div>

<script>
/* ===== Firebase Config Ø¢Ù…Ø§Ø¯Ù‡ ===== */
const firebaseConfig = {
  apiKey: "AIzaSyDn86gjV3Ena3Q4i84rCGNnnGTyDqEE2Xg",
  authDomain: "ams1-949e7.firebaseapp.com",
  databaseURL: "https://ams1-949e7-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "ams1-949e7",
  storageBucket: "ams1-949e7.firebasestorage.app",
  messagingSenderId: "1061973812134",
  appId: "1:1061973812134:web:94e44e9931b5ae9f3d2567",
  measurementId: "G-HDJ81BTE70"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const storage = firebase.storage();

// Local variables
let currentUser = null;
let currentChatUser = null;

// Auth Elements
const authDiv = document.getElementById("auth");
const chatDiv = document.getElementById("chat-container");
const authMsg = document.getElementById("auth-msg");
const userListDiv = document.getElementById("user-list");
const chatBox = document.getElementById("chat-box");

// Chat Input
const msgInput = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");
const sendImgBtn = document.getElementById("sendImgBtn");
const sendAudioBtn = document.getElementById("sendAudioBtn");

// Video Section
const videoSection = document.getElementById("video-section");
const videoLinkInput = document.getElementById("videoLinkInput");
const addVideoBtn = document.getElementById("addVideoBtn");

/* ===== Auth Functions ===== */
document.getElementById("registerBtn").onclick = () => {
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value.trim();
  if(!username || !password){ authMsg.textContent="Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯"; return; }
  db.ref('users/'+username).get().then(snapshot=>{
    if(snapshot.exists()){ authMsg.textContent="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª"; return; }
    db.ref('users/'+username).set({password:password,online:false});
    authMsg.style.color="green"; authMsg.textContent="Ø«Ø¨Øª Ù†Ø§Ù… Ù…ÙˆÙÙ‚ØŒ Ø­Ø§Ù„Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯";
  });
};

document.getElementById("loginBtn").onclick = () => {
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value.trim();
  if(!username || !password){ authMsg.textContent="Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯"; return; }
  db.ref('users/'+username).get().then(snapshot=>{
    if(!snapshot.exists()){ authMsg.textContent="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡"; return; }
    if(snapshot.val().password !== password){ authMsg.textContent="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª"; return; }
    currentUser = username;
    authDiv.classList.add("hidden");
    chatDiv.classList.remove("hidden");
    db.ref('users/'+currentUser+'/online').set(true);
    loadUserList();
    listenMessages();
    loadVideos();
  });
};

/* ===== Users Online ===== */
function loadUserList(){
  db.ref('users').on('value',snapshot=>{
    userListDiv.innerHTML="";
    snapshot.forEach(userSnap=>{
      const u = userSnap.key;
      const val = userSnap.val();
      if(u === currentUser || !val.online) return;
      const div = document.createElement("div");
      div.textContent = u;
      div.onclick=()=>{ currentChatUser = u; chatBox.innerHTML=""; listenMessages(); };
      userListDiv.appendChild(div);
    });
  });
}

/* ===== Chat Functions ===== */
function listenMessages(){
  if(!currentChatUser) return;
  const chatRef = db.ref('messages/'+currentUser+'_'+currentChatUser);
  chatRef.off();
  chatRef.on('child_added', snapshot=>{
    const msg = snapshot.val();
    if(msg.sender !== currentUser) addMessage(msg,'received');
  });
}

function addMessage(msg,type){
  const div = document.createElement("div");
  div.className='message '+type;
  if(msg.text.startsWith('[Image] ')){
    const url = msg.text.replace('[Image] ','');
    div.innerHTML = `<img src="${url}" style="max-width:100%;border-radius:10px;">`;
  } else if(msg.text.startsWith('[Audio] ')){
    const url = msg.text.replace('[Audio] ','');
    div.innerHTML = `<audio controls src="${url}" style="width:100%;"></audio>`;
  } else {
    div.textContent = msg.text;
  }
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
}

sendBtn.onclick = () => {
  if(!currentChatUser) return alert("ÛŒÚ© Ú©Ø§Ø±Ø¨Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯");
  const text = msgInput.value.trim();
  if(!text) return;
  const msgData = {sender:currentUser,text:text,timestamp:Date.now()};
  db.ref('messages/'+currentUser+'_'+currentChatUser).push(msgData);
  db.ref('messages/'+currentChatUser+'_'+currentUser).push(msgData);
  addMessage(msgData,'sent');
  msgInput.value="";
};

/* ===== Send Image ===== */
sendImgBtn.onclick = () => {
  const fileInput = document.createElement("input");
  fileInput.type="file";
  fileInput.accept="image/*";
  fileInput.onchange = ()=>{
    const file = fileInput.files[0];
    if(!file) return;
    const storageRef = storage.ref('images/'+Date.now()+"_"+file.name);
    storageRef.put(file).then(snapshot=>{
      snapshot.ref.getDownloadURL().then(url=>{
        const msgData = {sender:currentUser,text:'[Image] '+url,timestamp:Date.now()};
        db.ref('messages/'+currentChatUser+'_'+currentUser).push(msgData);
        db.ref('messages/'+currentUser+'_'+currentChatUser).push(msgData);
        addMessage(msgData,'sent');
      });
    });
  };
  fileInput.click();
};

/* ===== Send Audio ===== */
sendAudioBtn.onclick = () => {
  if(!navigator.mediaDevices || !window.MediaRecorder){ alert("Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² Ø¶Ø¨Ø· ØµØ¯Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯"); return; }
  navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
    const mediaRecorder=new MediaRecorder(stream);
    let chunks=[];
    mediaRecorder.ondataavailable=e=>{ chunks.push(e.data); };
    mediaRecorder.onstop=e=>{
      const blob=new Blob(chunks,{type:'audio/webm'});
      const url=URL.createObjectURL(blob);
      const msgData={sender:currentUser,text:'[Audio] '+url,timestamp:Date.now()};
      db.ref('messages/'+currentChatUser+'_'+currentUser).push(msgData);
      db.ref('messages/'+currentUser+'_'+currentChatUser).push(msgData);
      addMessage(msgData,'sent');
      chunks=[];
    };
    mediaRecorder.start();
    alert("Ø¶Ø¨Ø· Ø¢ØºØ§Ø² Ø´Ø¯ØŒ Ù¾Ø³ Ø§Ø² Ù¾Ø§ÛŒØ§Ù† OK Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯");
    setTimeout(()=>{ mediaRecorder.stop(); stream.getTracks().forEach(t=>t.stop()); },5000);
  });
};

/* ===== Videos TikTok ===== */
function convertToEmbed(link){
  const match = link.match(/\/video\/(\d+)/);
  if(match) return `https://www.tiktok.com/embed/${match[1]}`;
  return link;
}

addVideoBtn.onclick = () => {
  const link = videoLinkInput.value.trim();
  if(!link) return alert("Ù„ÛŒÙ†Ú© ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
  const embedLink = convertToEmbed(link);
  db.ref('videos').push(embedLink);
  videoLinkInput.value="";
};

function loadVideos(){
  db.ref('videos').on('value', snapshot=>{
    videoSection.innerHTML="";
    snapshot.forEach(v=>{
      const div = document.createElement("div");
      div.className='video-item';
      div.innerHTML=`<iframe src="${v.val()}" frameborder="0" allowfullscreen></iframe>`;
      videoSection.appendChild(div);
    });
  });
}

// Logout on close
window.addEventListener('beforeunload',()=>{
  if(currentUser) db.ref('users/'+currentUser+'/online').set(false);
});
</script>
</body>
</html>
