<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ú†Øª Ø¢Ù†Ù„Ø§ÛŒÙ† Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø¨Ø§ Firebase</title>
<style>
body{font-family:sans-serif;background:#f0f0f0;margin:0;padding:0;display:flex;flex-direction:column;height:100vh;}
.hidden{display:none;}
#auth,#chat-container{margin:auto;width:95%;max-width:600px;}
#auth input,#auth button,#chat-input input,#chat-input button,#videoLinkInput,#addVideoBtn{padding:10px;margin:5px;border-radius:5px;border:1px solid #ccc;}
#auth button,#chat-input button,#addVideoBtn{border:none;background:#2196F3;color:white;cursor:pointer;}
#chat-box{height:400px;overflow-y:auto;background:white;padding:10px;border-radius:5px;border:1px solid #ccc;margin-bottom:10px;}
.message{padding:8px 10px;border-radius:10px;margin:5px 0;max-width:70%;word-wrap:break-word;}
.sent{background:#4CAF50;color:white;margin-left:auto;}
.received{background:#2196F3;color:white;margin-right:auto;}
#user-list{display:flex;overflow-x:auto;margin-bottom:10px;}
#user-list div{padding:8px 12px;background:#ff5722;color:white;border-radius:20px;margin-right:5px;cursor:pointer;white-space:nowrap;}
#chat-input{display:flex;}
#video-section{margin-top:20px;}
.video-item{margin-bottom:10px;}
.video-item iframe{width:100%;height:250px;border-radius:10px;}
</style>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
</head>
<body>

<!-- Auth -->
<div id="auth">
  <h2>Ø«Ø¨Øª Ù†Ø§Ù… / ÙˆØ±ÙˆØ¯</h2>
  <input type="text" id="username" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ">
  <input type="password" id="password" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
  <button id="registerBtn">Ø«Ø¨Øª Ù†Ø§Ù…</button>
  <button id="loginBtn">ÙˆØ±ÙˆØ¯</button>
  <p id="auth-msg"></p>
</div>

<!-- Chat -->
<div id="chat-container" class="hidden">
  <h3>Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ†</h3>
  <div id="user-list"></div>
  <div id="chat-box"></div>
  <div id="chat-input">
    <input type="text" id="msgInput" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯">
    <button id="sendBtn">Ø§Ø±Ø³Ø§Ù„</button>
    <button id="sendImgBtn">ğŸ“·</button>
    <button id="sendAudioBtn">ğŸ¤</button>
  </div>
  
  <h3>ÙˆÛŒØ¯Ø¦ÙˆÙ‡Ø§ÛŒ TikTok</h3>
  <div id="video-section"></div>
  <input type="text" id="videoLinkInput" placeholder="Ù„ÛŒÙ†Ú© ÙˆÛŒØ¯Ø¦Ùˆ TikTok">
  <button id="addVideoBtn">Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙˆÛŒØ¯Ø¦Ùˆ</button>
</div>

<script>
/* ===== Firebase Config ===== */
const firebaseConfig = {
  apiKey: "AIzaSyDn86gjV3Ena3Q4i84rCGNnnGTyDqEE2Xg",
  authDomain: "ams1-949e7.firebaseapp.com",
  databaseURL: "https://ams1-949e7-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "ams1-949e7",
  storageBucket: "ams1-949e7.appspot.com",
  messagingSenderId: "1061973812134",
  appId: "1:1061973812134:web:94e44e9931b5ae9f3d2567",
  measurementId: "G-HDJ81BTE70"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const storage = firebase.storage();

/* ===== Variables ===== */
let currentUser = null;
let currentChatUser = null;

/* ===== Elements ===== */
const authDiv = document.getElementById("auth");
const chatDiv = document.getElementById("chat-container");
const authMsg = document.getElementById("auth-msg");
const userListDiv = document.getElementById("user-list");
const chatBox = document.getElementById("chat-box");

const msgInput = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");
const sendImgBtn = document.getElementById("sendImgBtn");
const sendAudioBtn = document.getElementById("sendAudioBtn");

const videoSection = document.getElementById("video-section");
const videoLinkInput = document.getElementById("videoLinkInput");
const addVideoBtn = document.getElementById("addVideoBtn");

/* ===== Auth Functions ===== */
document.getElementById("registerBtn").onclick = () => {
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value.trim();
  if(!username||!password){ authMsg.textContent="Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯"; return;}
  db.ref('users/'+username).get().then(snap=>{
    if(snap.exists()){ authMsg.textContent="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª"; return;}
    db.ref('users/'+username).set({password:password,online:false});
    authMsg.style.color="green"; authMsg.textContent="Ø«Ø¨Øª Ù†Ø§Ù… Ù…ÙˆÙÙ‚ØŒ Ø­Ø§Ù„Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯";
  });
};

document.getElementById("loginBtn").onclick = () => {
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value.trim();
  if(!username||!password){ authMsg.textContent="Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯"; return;}
  db.ref('users/'+username).get().then(snap=>{
    if(!snap.exists()){ authMsg.textContent="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡"; return;}
    if(snap.val().password!==password){ authMsg.textContent="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª"; return;}
    currentUser=username;
    authDiv.classList.add("hidden");
    chatDiv.classList.remove("hidden");
    db.ref('users/'+currentUser+'/online').set(true);
    loadUserList();
    listenMessages();
    loadVideos();
  });
};

/* ===== Users Online ===== */
function loadUserList(){
  db.ref('users').on('value',snapshot=>{
    userListDiv.innerHTML="";
    snapshot.forEach(userSnap=>{
      const u = userSnap.key;
      const val = userSnap.val();
      if(u===currentUser||!val.online) return;
      const div = document.createElement("div");
      div.textContent = u;
      div.onclick=()=>{ currentChatUser=u; chatBox.innerHTML=""; listenMessages(); };
      userListDiv.appendChild(div);
    });
  });
}

/* ===== Chat Functions ===== */
function listenMessages(){
  if(!currentChatUser) return;
  const chatId = [currentUser,currentChatUser].sort().join("_");
  db.ref('messages/'+chatId).off();
  db.ref('messages/'+chatId).on('child_added',snap=>{
    const msg = snap.val();
    addMessage(msg, msg.sender===currentUser?'sent':'received');
  });
}

function addMessage(msg,type){
  const div=document.createElement("div");
  div.className='message '+type;
  if(msg.type==='image'){
    div.innerHTML=`<img src="${msg.text}" style="max-width:100%;border-radius:10px;">`;
  } else if(msg.type==='audio'){
    div.innerHTML=`<audio controls src="${msg.text}" style="width:100%;"></audio>`;
  } else {
    div.textContent=msg.text;
  }
  chatBox.appendChild(div);
  chatBox.scrollTop=chatBox.scrollHeight;
}

/* ===== Send Message ===== */
sendBtn.onclick = () => {
  if(!currentChatUser) return alert("ÛŒÚ© Ú©Ø§Ø±Ø¨Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯");
  const text = msgInput.value.trim();
  if(!text) return;
  const chatId = [currentUser,currentChatUser].sort().join("_");
  const msgData = {sender:currentUser,text:type=text,type:'text',timestamp:Date.now()};
  db.ref('messages/'+chatId).push(msgData);
  addMessage(msgData,'sent');
  msgInput.value="";
};

/* ===== Send Image ===== */
sendImgBtn.onclick = () => {
  if(!currentChatUser) return alert("ÛŒÚ© Ú©Ø§Ø±Ø¨Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯");
  const fileInput = document.createElement("input");
  fileInput.type="file";
  fileInput.accept="image/*";
  fileInput.onchange=()=>{
    const file = fileInput.files[0];
    if(!file) return;
    const storageRef = storage.ref('images/'+Date.now()+"_"+file.name);
    storageRef.put(file).then(snap=>{
      snap.ref.getDownloadURL().then(url=>{
        const chatId = [currentUser,currentChatUser].sort().join("_");
        const msgData={sender:currentUser,text:url,type:'image',timestamp:Date.now()};
        db.ref('messages/'+chatId).push(msgData);
        addMessage(msgData,'sent');
      });
    });
  };
  fileInput.click();
};

/* ===== Send Audio ===== */
sendAudioBtn.onclick=()=>{
  if(!currentChatUser) return alert("ÛŒÚ© Ú©Ø§Ø±Ø¨Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯");
  if(!navigator.mediaDevices||!window.MediaRecorder){ alert("Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² Ø¶Ø¨Ø· ØµØ¯Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯"); return; }
  navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
    const recorder=new MediaRecorder(stream);
    let chunks=[];
    recorder.ondataavailable=e=>chunks.push(e.data);
    recorder.onstop=e=>{
      const blob=new Blob(chunks,{type:'audio/webm'});
      const storageRef = storage.ref('audio/'+Date.now()+'.webm');
      storageRef.put(blob).then(snap=>{
        snap.ref.getDownloadURL().then(url=>{
          const chatId=[currentUser,currentChatUser].sort().join("_");
          const msgData={sender:currentUser,text:url,type:'audio',timestamp:Date.now()};
          db.ref('messages/'+chatId).push(msgData);
          addMessage(msgData,'sent');
        });
      });
    };
    recorder.start();
    alert("Ø¶Ø¨Ø· Ø¢ØºØ§Ø² Ø´Ø¯. Ù¾Ø³ Ø§Ø² Ù¾Ø§ÛŒØ§Ù†ØŒ OK Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.");
    setTimeout(()=>{ recorder.stop(); stream.getTracks().forEach(t=>t.stop()); },5000);
  });
};

/* ===== Videos TikTok ===== */
function convertToEmbed(link){
  const match = link.match(/\/video\/(\d+)/);
  if(match) return `https://www.tiktok.com/embed/${match[1]}`;
  return link;
}
addVideoBtn.onclick = () => {
  const link = videoLinkInput.value.trim();
  if(!link) return alert("Ù„ÛŒÙ†Ú© ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
  const embedLink = convertToEmbed(link);
  db.ref('videos').push(embedLink);
  videoLinkInput.value="";
};
function loadVideos(){
  db.ref('videos').on('value', snap=>{
    videoSection.innerHTML="";
    snap.forEach(v=>{
      const div=document.createElement("div");
      div.className='video-item';
      div.innerHTML=`<iframe src="${v.val()}" frameborder="0" allowfullscreen></iframe>`;
      videoSection.appendChild(div);
    });
  });
}

// Logout
window.addEventListener('beforeunload',()=>{ if(currentUser) db.ref('users/'+currentUser+'/online').set(false); });
</script>
</body>
</html> 
