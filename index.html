<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ú†Øª Ø¢Ù†Ù„Ø§ÛŒÙ† Ø¨Ø§ Ù„Ø§Ú¯ÛŒÙ†</title>
<style>
body{font-family:sans-serif;background:#f0f0f0;margin:0;padding:0;display:flex;flex-direction:column;height:100vh;}
.hidden{display:none;}
#auth,#chat-container{margin:auto;width:95%;max-width:600px;}
#auth input,#auth button,#chat-input input,#chat-input button{padding:10px;margin:5px;border-radius:5px;border:1px solid #ccc;}
#auth button,#chat-input button{border:none;background:#2196F3;color:white;cursor:pointer;}
#chat-box{height:400px;overflow-y:auto;background:white;padding:10px;border-radius:5px;border:1px solid #ccc;margin-bottom:10px;}
.message{padding:8px 10px;border-radius:10px;margin:5px 0;max-width:70%;}
.sent{background:#4CAF50;color:white;margin-left:auto;}
.received{background:#2196F3;color:white;margin-right:auto;}
#user-list{display:flex;overflow-x:auto;margin-bottom:10px;}
#user-list div{padding:8px 12px;background:#ff5722;color:white;border-radius:20px;margin-right:5px;cursor:pointer;white-space:nowrap;}
#chat-input{display:flex;}
</style>
<script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>
</head>
<body>

<!-- Auth -->
<div id="auth">
  <h2>Ø«Ø¨Øª Ù†Ø§Ù… / ÙˆØ±ÙˆØ¯</h2>
  <input type="text" id="username" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ">
  <button id="registerBtn">Ø«Ø¨Øª Ù†Ø§Ù…</button>
  <button id="loginBtn">ÙˆØ±ÙˆØ¯</button>
  <p id="auth-msg"></p>
</div>

<!-- Chat -->
<div id="chat-container" class="hidden">
  <h3>Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ†</h3>
  <div id="user-list"></div>
  <div id="chat-box"></div>
  <div id="chat-input">
    <input type="text" id="msgInput" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯">
    <button id="sendBtn">Ø§Ø±Ø³Ø§Ù„</button>
    <button id="sendAudioBtn">ğŸ¤ Ø¶Ø¨Ø· ØµØ¯Ø§</button>
  </div>
  <p id="peer-id-display"></p>
</div>

<script>
// LocalStorage Helpers
const USERS_KEY="webrtc_chat_users";
let currentUser=null;
let peer=null;
let connections={}; // peerId -> connection

function loadUsers(){ return JSON.parse(localStorage.getItem(USERS_KEY)||"{}"); }
function saveUsers(users){ localStorage.setItem(USERS_KEY,JSON.stringify(users)); }

// Auth
const authDiv=document.getElementById("auth");
const chatDiv=document.getElementById("chat-container");
const authMsg=document.getElementById("auth-msg");
const userListDiv=document.getElementById("user-list");
const chatBox=document.getElementById("chat-box");

document.getElementById("registerBtn").onclick=()=>{
  const username=document.getElementById("username").value.trim();
  if(!username){ authMsg.textContent="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡"; return; }
  let users=loadUsers();
  if(users[username]){ authMsg.textContent="Ø§ÛŒÙ† Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù‚Ø¨Ù„Ø§ Ø«Ø¨Øª Ø´Ø¯Ù‡"; return; }
  users[username]={peerId:""}; saveUsers(users);
  authMsg.style.color="green"; authMsg.textContent="Ø«Ø¨Øª Ù†Ø§Ù… Ù…ÙˆÙÙ‚! Ø­Ø§Ù„Ø§ ÙˆØ±ÙˆØ¯ Ú©Ù†ÛŒØ¯";
};

document.getElementById("loginBtn").onclick=()=>{
  const username=document.getElementById("username").value.trim();
  if(!username){ authMsg.textContent="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡"; return; }
  let users=loadUsers();
  if(!users[username]){ authMsg.textContent="Ø§ÛŒÙ† Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡"; return; }
  currentUser=username;
  authDiv.classList.add("hidden");
  chatDiv.classList.remove("hidden");
  startPeer();
};

// WebRTC / PeerJS
function startPeer(){
  peer=new Peer(currentUser+Math.floor(Math.random()*1000),{host:'0.peerjs.com',secure:true,port:443});
  peer.on('open',id=>{
    document.getElementById("peer-id-display").textContent="Peer ID: "+id;
    // Ø°Ø®ÛŒØ±Ù‡ peerId Ø¯Ø± users
    let users=loadUsers(); users[currentUser].peerId=id; saveUsers(users);
    loadUserList();
  });

  peer.on('connection',c=>{
    connections[c.peer]=c;
    setupConnection(c);
  });
}

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ†
function loadUserList(){
  userListDiv.innerHTML="";
  let users=loadUsers();
  for(let u in users){
    if(u===currentUser) continue;
    const div=document.createElement("div");
    div.textContent=u;
    div.onclick=()=>{ connectToUser(u); };
    userListDiv.appendChild(div);
  }
}

// Ø§ØªØµØ§Ù„ Ø¨Ù‡ ÛŒÚ© Ú©Ø§Ø±Ø¨Ø± Ø¯ÛŒÚ¯Ø±
function connectToUser(username){
  let users=loadUsers();
  let peerId=users[username]?.peerId;
  if(!peerId){ alert("Ú©Ø§Ø±Ø¨Ø± Ø¢ÙÙ„Ø§ÛŒÙ† Ø§Ø³Øª"); return; }
  if(connections[peerId] && connections[peerId].open) return; // Ù‚Ø¨Ù„Ø§ Ù…ØªØµÙ„
  let c=peer.connect(peerId);
  connections[peerId]=c;
  setupConnection(c);
}

// ØªÙ†Ø¸ÛŒÙ… Ø§ØªØµØ§Ù„
function setupConnection(c){
  c.on('open',()=>{ console.log("Connected to "+c.peer); });
  c.on('data',data=>{
    if(data.type==="text") addMessage(data.text,'received');
    if(data.type==="audio") addMessage(data.url,'received',true);
  });
}

// Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…
document.getElementById("sendBtn").onclick=()=>{
  const text=document.getElementById("msgInput").value.trim();
  if(!text) return;
  for(let p in connections){ if(connections[p].open) connections[p].send({type:"text",text}); }
  addMessage(text,'sent');
  document.getElementById("msgInput").value="";
};

// Ø¶Ø¨Ø· Ùˆ Ø§Ø±Ø³Ø§Ù„ ØµØ¯Ø§
document.getElementById("sendAudioBtn").onclick=async()=>{
  if(!navigator.mediaDevices || !window.MediaRecorder){ alert("Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² Ø¶Ø¨Ø· ØµØ¯Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯"); return;}
  const stream=await navigator.mediaDevices.getUserMedia({audio:true});
  const mediaRecorder=new MediaRecorder(stream);
  let chunks=[];
  mediaRecorder.ondataavailable=e=>chunks.push(e.data);
  mediaRecorder.onstop=e=>{
    const blob=new Blob(chunks,{type:'audio/webm'});
    const url=URL.createObjectURL(blob);
    for(let p in connections){ if(connections[p].open) connections[p].send({type:"audio",url}); }
    addMessage(url,'sent',true);
    chunks=[];
  };
  mediaRecorder.start();
  alert("Ø¶Ø¨Ø· Ø¢ØºØ§Ø² Ø´Ø¯ØŒ Ù¾Ø³ Ø§Ø² Ù¾Ø§ÛŒØ§Ù† OK Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.");
  setTimeout(()=>{ mediaRecorder.stop(); stream.getTracks().forEach(t=>t.stop()); },5000);
};

// Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ú†Øª Ø¨Ø§Ú©Ø³
function addMessage(text,type,isAudio=false){
  const div=document.createElement("div");
  div.className='message '+type;
  if(isAudio){
    div.innerHTML=`<audio controls src="${text}" style="width:100%;margin-top:5px;"></audio>`;
  } else {
    div.textContent=text;
  }
  chatBox.appendChild(div);
  chatBox.scrollTop=chatBox.scrollHeight;
}
</script>
</body>
</html>
