<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>TikChat â€” Fullscreen TikTok-like</title>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b0f17; --panel:#0f1720; --muted:#9aa4b2; --accent:#ff2e63; --accent2:#08d9d6;
    --white:#ffffff;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:"Vazirmatn",sans-serif;background:linear-gradient(180deg,#071021,#0b0f17);color:var(--white);-webkit-font-smoothing:antialiased}
  /* App layout */
  #app{height:100vh;display:flex;flex-direction:column;overflow:hidden}
  /* Top bar (minimal) */
  header.appbar{height:48px;display:flex;align-items:center;justify-content:space-between;padding:0 12px;background:transparent;z-index:30}
  header.appbar .brand{font-weight:700;font-size:18px}
  /* Main area */
  .view{flex:1;position:relative;overflow:hidden}
  /* Feed container - vertical snap */
  .feed{
    height:100%;width:100%;overflow-y:auto;scroll-snap-type:y mandatory;-webkit-overflow-scrolling:touch;
  }
  .video-card{
    height:100vh; width:100%; position:relative; scroll-snap-align:start; display:flex;align-items:flex-end;justify-content:center;
  }
  .video-card iframe, .video-card video{
    position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;border:0;
    background:#000;border-radius:0;
  }

  /* overlay right buttons */
  .side-actions{position:absolute;right:12px;bottom:120px;display:flex;flex-direction:column;gap:14px;align-items:center;z-index:40}
  .action-btn{width:52px;height:52px;border-radius:12px;background:rgba(255,255,255,0.06);display:flex;align-items:center;justify-content:center;color:var(--white);font-size:18px;backdrop-filter:blur(4px)}
  .action-btn .count{font-size:12px;margin-top:6px;display:block;text-align:center;color:var(--muted)}

  /* bottom nav bar */
  nav.bottom-nav{height:64px;display:flex;align-items:center;justify-content:space-around;background:linear-gradient(180deg,rgba(0,0,0,0.3),rgba(0,0,0,0.6));position:relative;z-index:50}
  nav.bottom-nav button{background:transparent;border:0;color:var(--white);font-weight:600}

  /* Chat / Manage full pages */
  .panel{position:absolute;inset:0;background:linear-gradient(180deg,#071021,#0b0f17);z-index:100;display:flex;flex-direction:column}
  .panel.hidden{display:none}
  .panel header{height:56px;display:flex;align-items:center;justify-content:space-between;padding:0 12px;border-bottom:1px solid rgba(255,255,255,0.03)}
  .panel .content{flex:1;overflow:auto;padding:12px}

  /* Chat UI */
  .user-list{display:flex;gap:8px;overflow:auto;padding-bottom:10px}
  .user-pill{padding:8px 12px;background:rgba(255,255,255,0.06);border-radius:20px;cursor:pointer;white-space:nowrap}
  .chat-window{display:flex;flex-direction:column;height:100%}
  .messages{flex:1;overflow:auto;display:flex;flex-direction:column;gap:10px;padding:8px}
  .msg{max-width:72%;padding:10px;border-radius:12px;background:rgba(255,255,255,0.04)}
  .msg.me{margin-left:auto;background:linear-gradient(90deg,var(--accent2),#07b3a8);color:#001}
  .composer{display:flex;gap:8px;padding:8px;border-top:1px solid rgba(255,255,255,0.03)}
  .composer input[type=text]{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--white)}

  /* Manage UI */
  .manage-controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  .manage-controls input{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--white)}
  .manage-controls button{padding:10px 12px;border-radius:8px;border:0;background:var(--accent);color:#fff}

  /* small responsive tweaks */
  @media(min-width:900px){
    .side-actions{right:28px}
    nav.bottom-nav{position:relative}
  }
  /* helper */
  .muted{color:var(--muted);font-size:13px}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;color:var(--white)}
  a.link{color:var(--accent2)}
</style>
</head>
<body>
<div id="app">
  <header class="appbar">
    <div class="brand">TikChat</div>
    <div id="userBadge" class="muted"></div>
  </header>

  <main class="view">
    <!-- Feed -->
    <div id="feed" class="feed" aria-live="polite"></div>

    <!-- Chat panel (full) -->
    <div id="chatPanel" class="panel hidden" role="dialog" aria-modal="true">
      <header>
        <div>Ú†Øª</div>
        <div><button id="closeChat" class="btn-ghost">Ø¨Ø³ØªÙ†</button></div>
      </header>
      <div class="content">
        <div class="muted">Ø¬Ø³ØªØ¬Ùˆ Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±</div>
        <div style="height:8px"></div>
        <div style="display:flex;gap:8px">
          <input id="searchUserInput" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ..." style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--white)">
          <button id="newChatBtn" class="btn-ghost">Ø´Ø±ÙˆØ¹</button>
        </div>
        <div id="userList" class="user-list" style="margin-top:12px"></div>

        <div style="height:12px"></div>

        <div id="chatArea" class="chat-window hidden">
          <div id="chatWith" style="padding:6px 0;font-weight:600"></div>
          <div id="messages" class="messages"></div>
          <div class="composer">
            <input id="chatInput" type="text" placeholder="Ù¾ÛŒØ§Ù…..." />
            <button id="sendTextBtn" class="btn-ghost">Ø§Ø±Ø³Ø§Ù„</button>
            <button id="attachImageBtn" class="btn-ghost">ğŸ“·</button>
            <button id="recordAudioBtn" class="btn-ghost">ğŸ¤ Ø¶Ø¨Ø·</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Manage panel (full) -->
    <div id="managePanel" class="panel hidden">
      <header>
        <div>Ù…Ø¯ÛŒØ±ÛŒØª ÙˆÛŒØ¯Ø¦ÙˆÙ‡Ø§</div>
        <div><button id="closeManage" class="btn-ghost">Ø¨Ø³ØªÙ†</button></div>
      </header>
      <div class="content">
        <div class="manage-controls">
          <input id="videoLink" placeholder="Ù‚Ø±Ø§Ø± Ø¯Ø§Ø¯Ù† Ù„ÛŒÙ†Ú© TikTok (Ù‡Ø± Ù†ÙˆØ¹ Ù„ÛŒÙ†Ú© Ù…Ø¹Ù…ÙˆÙ„ÛŒ ÛŒØ§ embed)" />
          <button id="addVideoBtn">Ø§ÙØ²ÙˆØ¯Ù†</button>
          <button id="clearAllBtn">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡</button>
        </div>
        <div id="manageList"></div>
        <div style="height:24px"></div>
        <div class="muted">ØªÙˆØ¶ÛŒØ­: Ù„ÛŒÙ†Ú© Ù…Ø¹Ù…ÙˆÙ„ÛŒ ØªÛŒÚ©â€ŒØªØ§Ú© (https://www.tiktok.com/@user/video/ID) Ø¨Ù‡â€ŒØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ù‡ Ù†Ø³Ø®Ù‡ embed ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
      </div>
    </div>
  </main>

  <nav class="bottom-nav" aria-label="navigation">
    <button id="navHome">Ø®Ø§Ù†Ù‡</button>
    <button id="navChat">Ú†Øª</button>
    <button id="navManage">Ù…Ø¯ÛŒØ±ÛŒØª</button>
  </nav>
</div>

<script>
/* ======= Storage Keys ======= */
const USERS_KEY = 'tiktok_chat_users_v1';
const CHATS_KEY = 'tiktok_chat_msgs_v1';
const VIDEOS_KEY = 'tiktok_chat_videos_v1';

/* ======= App State ======= */
let state = {
  currentUser: null,
  currentChatTarget: null,
  videosLoaded: 0,
  perLoad: 1
};

/* ======= Helpers: LocalStorage ======= */
function loadJSON(key, fallback){ try{ return JSON.parse(localStorage.getItem(key)) || fallback; } catch(e){ return fallback; } }
function saveJSON(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }

function ensureInitialData(){
  if(!localStorage.getItem(USERS_KEY)){
    // create a sample user for demo: user1/password
    const u = { 'alice':'pass', 'bob':'pass' };
    saveJSON(USERS_KEY,u);
  }
  if(!localStorage.getItem(VIDEOS_KEY)){
    // sample embed links (these are embed URLs or will be converted)
    const sample = [
      'https://www.tiktok.com/embed/7163153089386168838',
      'https://www.tiktok.com/embed/7183459084386578434',
      'https://www.tiktok.com/embed/7191234567890123456'
    ];
    saveJSON(VIDEOS_KEY,sample);
  }
  if(!localStorage.getItem(CHATS_KEY)) saveJSON(CHATS_KEY,{});
}
ensureInitialData();

/* ======= UI refs ======= */
const feed = document.getElementById('feed');
const userBadge = document.getElementById('userBadge');

const chatPanel = document.getElementById('chatPanel');
const managePanel = document.getElementById('managePanel');
const navHome = document.getElementById('navHome');
const navChat = document.getElementById('navChat');
const navManage = document.getElementById('navManage');

/* ======= Auth at first use (simple prompt) ======= */
function askLogin(){
  // simple modal prompt for username/password using prompt() to keep single-file minimal
  let users = loadJSON(USERS_KEY,{});
  const username = prompt("Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ø¨Ø±Ø§ÛŒ Ù†Ù…ÙˆÙ†Ù‡: alice ÛŒØ§ bob)").trim();
  if(!username) return askLogin();
  if(!users[username]){
    const create = confirm("Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª â€” Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¨Ø³Ø§Ø²ÛŒØ¯ØŸ");
    if(!create) return askLogin();
    const pass = prompt("Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:");
    users[username]=pass || '';
    saveJSON(USERS_KEY,users);
    state.currentUser = username;
    userBadge.textContent = username;
    alert('Ø«Ø¨Øª Ù†Ø§Ù… Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯ Ùˆ ÙˆØ§Ø±Ø¯ Ø´Ø¯ÛŒ.');
    return initAfterLogin();
  } else {
    const pass = prompt("Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:");
    if(users[username] !== pass){
      alert('Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª'); return askLogin();
    }
    state.currentUser = username;
    userBadge.textContent = username;
    return initAfterLogin();
  }
}

/* ======= Init after login ======= */
function initAfterLogin(){
  // render first batch
  state.videosLoaded = 0;
  feed.innerHTML = '';
  loadMoreVideos();
  // setup bottom nav
  showTab('home');
  // update chat user list UI
  renderUserList();
}

/* ======= Conversion: make embed URL from common TikTok links ======= */
function toEmbedURL(link){
  // try to find numeric video id
  try {
    // normalize
    link = link.trim();
    // if already embed return as is
    if(link.includes('/embed/')) return link;
    // find /video/{id}
    const m = link.match(/\/video\/(\d+)/);
    if(m) return `https://www.tiktok.com/embed/${m[1]}`;
    // short url like vm.tiktok.com/xxxxx -> cannot resolve without server; return as-is
    return link;
  } catch(e){ return link; }
}

/* ======= Load / Infinite feed ======= */
function loadMoreVideos(){
  const videos = loadJSON(VIDEOS_KEY,[]);
  if(state.videosLoaded >= videos.length) return;
  const to = Math.min(state.videosLoaded + state.perLoad, videos.length);
  for(let i=state.videosLoaded;i<to;i++){
    const link = videos[i];
    const card = createVideoCard(link, i);
    feed.appendChild(card);
  }
  state.videosLoaded = to;
}
function createVideoCard(link, index){
  const card = document.createElement('div');
  card.className = 'video-card';
  // iframe embed
  const iframe = document.createElement('iframe');
  iframe.src = link;
  iframe.allow = "autoplay; fullscreen; picture-in-picture";
  iframe.loading = 'lazy';
  card.appendChild(iframe);

  // right-side actions
  const side = document.createElement('div'); side.className='side-actions';
  // like
  const like = document.createElement('div'); like.className='action-btn'; like.innerHTML='â¤<div class="count">120K</div>';
  // comment
  const comment = document.createElement('div'); comment.className='action-btn'; comment.innerHTML='ğŸ’¬<div class="count">1.2K</div>';
  // share
  const share = document.createElement('div'); share.className='action-btn'; share.innerHTML='â†—<div class="count">Ø§Ø´ØªØ±Ø§Ú©</div>';
  // send to chat
  const send = document.createElement('div'); send.className='action-btn'; send.innerHTML='âœ‰ï¸<div class="count">Ø§Ø±Ø³Ø§Ù„</div>';
  send.onclick = ()=>{ if(!state.currentChatTarget){ alert('Ø§Ø¨ØªØ¯Ø§ Ø¨Ù‡ ØªØ¨ Ú†Øª Ø±ÙØªÙ‡ Ùˆ ÛŒÚ© Ú©Ø§Ø±Ø¨Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.'); showTab('chat'); return; } sendMessageTo(state.currentChatTarget, `[TikTok Video](${link})`); showTab('chat'); };
  side.appendChild(like); side.appendChild(comment); side.appendChild(share); side.appendChild(send);
  card.appendChild(side);

  // footer overlay: video index / info
  const footer = document.createElement('div'); footer.style.position='absolute'; footer.style.left='12px'; footer.style.bottom='18px'; footer.innerHTML=`<div style="font-weight:700">ÙˆÛŒØ¯Ø¦Ùˆ ${index+1}</div><div class="muted" style="font-size:13px">ØªÙˆØ¶ÛŒØ­ Ù†Ù…ÙˆÙ†Ù‡</div>`;
  card.appendChild(footer);

  return card;
}

/* infinite on scroll */
feed.addEventListener('scroll', ()=> {
  if(feed.scrollTop + feed.clientHeight >= feed.scrollHeight - 60){
    loadMoreVideos();
  }
});

/* ======= Bottom nav & panels ======= */
function showTab(tab){
  if(tab==='home'){ feed.style.display='block'; chatPanel.classList.add('hidden'); managePanel.classList.add('hidden'); navHome.classList.add('active'); navChat.classList.remove('active'); navManage.classList.remove('active'); }
  if(tab==='chat'){ feed.style.display='none'; chatPanel.classList.remove('hidden'); managePanel.classList.add('hidden'); navHome.classList.remove('active'); navChat.classList.add('active'); navManage.classList.remove('active'); renderUserList(); }
  if(tab==='manage'){ feed.style.display='none'; chatPanel.classList.add('hidden'); managePanel.classList.remove('hidden'); navHome.classList.remove('active'); navChat.classList.remove('active'); navManage.classList.add('active'); renderManageList(); }
}
navHome.addEventListener('click', ()=> showTab('home'));
navChat.addEventListener('click', ()=> showTab('chat'));
navManage.addEventListener('click', ()=> showTab('manage'));
document.getElementById('closeChat').onclick = ()=> showTab('home');
document.getElementById('closeManage').onclick = ()=> showTab('home');

/* ======= Manage: add/clear videos ======= */
document.getElementById('addVideoBtn').onclick = ()=>{
  const raw = document.getElementById('videoLink').value.trim();
  if(!raw){ alert('Ù„Ø·ÙØ§ Ù„ÛŒÙ†Ú© ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
  const embed = toEmbedURL(raw);
  const videos = loadJSON(VIDEOS_KEY,[]);
  videos.unshift(embed); // newest at top; because feed loads sequentially, we can put newest first or last; here newest first
  saveJSON(VIDEOS_KEY,videos);
  document.getElementById('videoLink').value='';
  // reset feed and reload
  feed.innerHTML=''; state.videosLoaded=0; loadMoreVideos();
  renderManageList();
};
document.getElementById('clearAllBtn').onclick = ()=>{
  if(confirm('Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡ ÙˆÛŒØ¯Ø¦ÙˆÙ‡Ø§ØŸ')){ saveJSON(VIDEOS_KEY,[]); feed.innerHTML=''; state.videosLoaded=0; renderManageList(); }
};
function renderManageList(){
  const list = document.getElementById('manageList');
  list.innerHTML='';
  const videos = loadJSON(VIDEOS_KEY,[]);
  videos.forEach((v,i)=>{
    const d = document.createElement('div'); d.style.display='flex'; d.style.justifyContent='space-between'; d.style.alignItems='center';
    const left = document.createElement('div'); left.style.maxWidth='78%'; left.style.overflow='hidden'; left.style.textOverflow='ellipsis'; left.textContent = v;
    const rm = document.createElement('button'); rm.textContent='Ø­Ø°Ù'; rm.className='btn-ghost'; rm.onclick=()=>{
      videos.splice(i,1); saveJSON(VIDEOS_KEY,videos); renderManageList(); feed.innerHTML=''; state.videosLoaded=0; loadMoreVideos();
    };
    d.appendChild(left); d.appendChild(rm); list.appendChild(d);
  });
}

/* ======= Chat functions ======= */
function renderUserList(){
  const ul = document.getElementById('userList'); ul.innerHTML='';
  const users = loadJSON(USERS_KEY,{});
  Object.keys(users).forEach(u=>{
    if(u === state.currentUser) return;
    const pill = document.createElement('div'); pill.className='user-pill'; pill.textContent = u;
    pill.onclick = ()=> {
      state.currentChatTarget = u;
      document.getElementById('chatArea').classList.remove('hidden');
      document.getElementById('chatWith').textContent = 'Ú†Øª Ø¨Ø§ ' + u;
      renderMessages();
      showTab('chat');
    };
    ul.appendChild(pill);
  });
}
document.getElementById('newChatBtn').onclick = ()=>{
  const q = document.getElementById('searchUserInput').value.trim();
  if(!q){ alert('Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
  const users = loadJSON(USERS_KEY,{});
  if(!users[q]){ if(confirm('Ú©Ø§Ø±Ø¨Ø± Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª â€” Ø§ÛŒØ¬Ø§Ø¯ Ø´ÙˆØ¯ØŸ')){ users[q]=''; saveJSON(USERS_KEY,users); } else return; }
  renderUserList();
};

/* Messages store: key by sorted pair */
function chatId(a,b){ return [a,b].sort().join('__'); }
function loadChats(){ return loadJSON(CHATS_KEY,{}); }
function saveChats(ch){ saveJSON(CHATS_KEY,ch); }
function renderMessages(){
  const box = document.getElementById('messages'); box.innerHTML='';
  if(!state.currentChatTarget) return;
  const chats = loadChats(); const id = chatId(state.currentUser, state.currentChatTarget); const msgs = chats[id]||[];
  msgs.forEach(m=>{
    const div = document.createElement('div'); div.className='msg ' + (m.sender===state.currentUser ? 'me' : '');
    // render content: detect tags: [TikTok Video](url), [Image](dataurl), [Audio](bloburl)
    let html = m.text
      .replace(/\[TikTok Video\]\((.*?)\)/g, '<iframe src="$1" allowfullscreen style="width:100%;height:60vh;border:0;border-radius:12px;margin-top:6px"></iframe>')
      .replace(/\[Image\]\((.*?)\)/g, '<img src="$1" style="max-width:100%;border-radius:10px;margin-top:6px">')
      .replace(/\[Audio\]\((.*?)\)/g, '<audio controls src="$1" style="width:100%;margin-top:6px"></audio>');
    div.innerHTML = html;
    div.classList.add('msg');
    if(m.sender===state.currentUser) div.classList.add('me');
    box.appendChild(div);
  });
  box.scrollTop = box.scrollHeight;
}

function sendMessageTo(target, text){
  if(!target){ alert('Ú¯ÛŒØ±Ù†Ø¯Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡'); return; }
  const chats = loadChats(); const id = chatId(state.currentUser, target);
  chats[id] = chats[id] || [];
  chats[id].push({sender: state.currentUser, text: text, time: Date.now()});
  saveChats(chats);
  if(state.currentChatTarget === target) renderMessages();
}

/* composer actions */
document.getElementById('sendTextBtn').onclick = ()=>{
  const input = document.getElementById('chatInput'); const txt = input.value.trim();
  if(!txt || !state.currentChatTarget){ if(!state.currentChatTarget) alert('Ø§Ø¨ØªØ¯Ø§ Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯'); return; }
  sendMessageTo(state.currentChatTarget, txt);
  input.value='';
};

document.getElementById('attachImageBtn').onclick = ()=>{
  if(!state.currentChatTarget){ alert('Ø§Ø¨ØªØ¯Ø§ Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯'); return; }
  const f = document.createElement('input'); f.type='file'; f.accept='image/*'; f.onchange = ()=>{
    const file = f.files[0]; if(!file) return;
    const reader = new FileReader(); reader.onload = ()=> {
      sendMessageTo(state.currentChatTarget, `[Image](${reader.result})`);
    }; reader.readAsDataURL(file);
  }; f.click();
};

/* ======= Audio recording (MediaRecorder) ======= */
let recorder = null, chunks = [];
document.getElementById('recordAudioBtn').onclick = async ()=>{
  if(!state.currentChatTarget){ alert('Ø§Ø¨ØªØ¯Ø§ Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯'); return; }
  if(!navigator.mediaDevices || !window.MediaRecorder){ alert('Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² Ø¶Ø¨Ø· ØµØ¯Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯ ÛŒØ§ Ù†ÛŒØ§Ø² Ø¨Ù‡ HTTPS Ø¯Ø§Ø±Ø¯'); return; }
  try{
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    recorder = new MediaRecorder(stream);
    chunks = [];
    recorder.ondataavailable = e => chunks.push(e.data);
    recorder.onstop = () => {
      const blob = new Blob(chunks, { type: 'audio/webm' });
      const url = URL.createObjectURL(blob);
      sendMessageTo(state.currentChatTarget, `[Audio](${url})`);
      // stop tracks
      stream.getTracks().forEach(t => t.stop());
    };
    recorder.start();
    alert('Ø¶Ø¨Ø· Ø´Ø±ÙˆØ¹ Ø´Ø¯ â€” Ø¨Ø±Ø§ÛŒ ØªÙˆÙ‚Ù OK Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯ (ÛŒØ§ Ù¾Ø³ Ø§Ø² 6 Ø«Ø§Ù†ÛŒÙ‡ Ø®ÙˆØ¯Ú©Ø§Ø± Ù…ØªÙˆÙ‚Ù Ù…ÛŒâ€ŒØ´ÙˆØ¯).');
    // auto stop after 6s to avoid huge blobs in LocalStorage
    setTimeout(()=>{ if(recorder && recorder.state === 'recording') recorder.stop(); }, 6000);
  }catch(err){
    alert('Ø¯Ø³ØªØ±Ø³ÛŒ Ø¶Ø¨Ø· ØµØ¯Ø§ Ø±Ø¯ Ø´Ø¯ ÛŒØ§ Ù…Ø´Ú©Ù„ Ø¯ÛŒÚ¯Ø±ÛŒ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯: ' + err.message);
  }
};

/* when navigating to chat, re-render messages every 1s to show updates */
setInterval(()=>{ if(!chatPanel.classList.contains('hidden')) renderMessages(); }, 1000);

/* ======= Start app ======= */
askLogin();
</script>
</body>
            </html> 
