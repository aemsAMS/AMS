<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Mini Social Chat â€“ Secure</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { margin:0; background:#111; color:#fff; font-family:Arial; }

#loginBox, #registerBox, #chatUI, #userListBox {
  display:none;
  padding:20px;
}

input, button {
  padding:10px;
  margin:5px 0;
  width:100%;
  border:none;
  border-radius:6px;
}

button { background:#444; color:#fff; cursor:pointer; }

/* Layout */
#main {
  display:flex;
  height:100vh;
}

#userList {
  width:30%;
  border-right:2px solid #222;
  overflow-y:auto;
}

#chatArea {
  width:70%;
  display:flex;
  flex-direction:column;
}

#messages {
  flex:1;
  padding:10px;
  overflow-y:auto;
}

.msg {
  background:#222;
  padding:8px;
  margin-bottom:8px;
  border-radius:6px;
}

.me { background:#333; }

.user {
  padding:12px;
  border-bottom:1px solid #222;
  cursor:pointer;
}

.user:hover { background:#222; }
</style>
</head>

<body>

<!-- REGISTER -->
<div id="registerBox">
  <h2>Register</h2>
  <input id="regName" placeholder="Username">
  <input id="regPass" type="password" placeholder="Password">
  <button onclick="register()">Register</button>
  <p>Already have an account? <a href="#" onclick="showLogin()">Login</a></p>
</div>

<!-- LOGIN -->
<div id="loginBox">
  <h2>Login</h2>
  <input id="logName" placeholder="Username">
  <input id="logPass" type="password" placeholder="Password">
  <button onclick="login()">Login</button>
  <p>No account? <a href="#" onclick="showRegister()">Register</a></p>
</div>

<!-- APP -->
<div id="main">

  <div id="userListBox">
    <h3>Online Users</h3>
    <div id="userList"></div>
  </div>

  <div id="chatUI">
    <h3 id="chatWith"></h3>
    <div id="chatArea">
      <div id="messages"></div>
      <input id="msg" placeholder="Message...">
      <button onclick="sendMsg()">Send</button>
    </div>
  </div>

</div>

<script>
/* ============================================================
      REGISTER / LOGIN with PASSWORD
   ============================================================ */

if (!localStorage.getItem("users")) localStorage.setItem("users", "{}");

function showLogin() {
  registerBox.style.display="none";
  loginBox.style.display="block";
}

function showRegister() {
  loginBox.style.display="none";
  registerBox.style.display="block";
}

function register() {
  let name = regName.value.trim();
  let pass = regPass.value.trim();

  if (!name || !pass) return alert("Fill all fields");

  let users = JSON.parse(localStorage.getItem("users"));

  if (users[name]) return alert("Username exists!");

  users[name] = pass;
  localStorage.setItem("users", JSON.stringify(users));

  localStorage.setItem("me", name);
  location.reload();
}

function login() {
  let name = logName.value.trim();
  let pass = logPass.value.trim();

  let users = JSON.parse(localStorage.getItem("users"));

  if (!users[name]) return alert("User not found");
  if (users[name] !== pass) return alert("Wrong password");

  localStorage.setItem("me", name);
  location.reload();
}


/* If user is logged in */
let me = localStorage.getItem("me");
if (!me) {
  showLogin();
} else {
  loginBox.style.display="none";
  registerBox.style.display="none";
  userListBox.style.display="block";
}



/* ============================================================
      ONLINE USERS (BroadcastChannel)
   ============================================================ */

let bc = new BroadcastChannel("online");
let onlineUsers = {};

bc.onmessage = e => {
  onlineUsers = e.data;
  loadUsers();
};

setInterval(() => {
  onlineUsers[me] = Date.now();
  bc.postMessage(onlineUsers);
  loadUsers();
}, 2000);

function loadUsers() {
  userList.innerHTML = "";
  let now = Date.now();

  Object.keys(onlineUsers).forEach(u => {
    if (now - onlineUsers[u] < 5000 && u !== me) {
      let div = document.createElement("div");
      div.className="user";
      div.innerText = u;
      div.onclick = () => startChat(u);
      userList.appendChild(div);
    }
  });
}



/* ============================================================
      MESSAGE STORAGE SYSTEM (localStorage)
   ============================================================ */

if (!localStorage.getItem("messages")) localStorage.setItem("messages", "{}");

function saveMessage(user, text, fromMe) {
  let all = JSON.parse(localStorage.getItem("messages"));
  if (!all[me]) all[me] = {};
  if (!all[me][user]) all[me][user] = [];

  all[me][user].push({
    from: fromMe ? me : user,
    text: text,
    time: Date.now()
  });

  localStorage.setItem("messages", JSON.stringify(all));
}

function loadOldMessages(user) {
  messages.innerHTML = "";
  let all = JSON.parse(localStorage.getItem("messages"));
  if (!all[me] || !all[me][user]) return;

  all[me][user].forEach(m => {
    let div = document.createElement("div");
    div.className = "msg";
    if (m.from === me) div.className += " me";
    div.innerText = m.from + ": " + m.text;
    messages.appendChild(div);
  });

  messages.scrollTop = messages.scrollHeight;
}



/* ============================================================
      WEBRTC CHAT SYSTEM
   ============================================================ */

let pc;
let channel;
let chatPartner = null;

async function startChat(user) {
  chatPartner = user;
  chatUI.style.display = "block";
  chatWith.innerText = "Chat with: " + user;

  loadOldMessages(user);

  pc = new RTCPeerConnection({ iceServers:[{urls:"stun:stun.l.google.com:19302"}] });
  channel = pc.createDataChannel("chat");
  channel.onmessage = e => receiveMsg(e.data);

  pc.onicecandidate = e => {
    if (e.candidate) signal(user, { candidate: e.candidate });
  };

  let offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  signal(user, { offer });
}

/* SIGNALING */
let signalBC = new BroadcastChannel("signal");

function signal(to, data) {
  signalBC.postMessage({ from: me, to, data });
}

signalBC.onmessage = async e => {
  let { from, to, data } = e.data;
  if (to !== me) return;

  if (!pc) {
    pc = new RTCPeerConnection({ iceServers:[{urls:"stun:stun.l.google.com:19302"}] });
    pc.ondatachannel = ev => {
      channel = ev.channel;
      channel.onmessage = e => receiveMsg(e.data);
    };
    pc.onicecandidate = ev => {
      if (ev.candidate) signal(from, { candidate: ev.candidate });
    };
  }

  if (data.offer) {
    await pc.setRemoteDescription(data.offer);
    let answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    signal(from, { answer });
  }

  if (data.answer) {
    await pc.setRemoteDescription(data.answer);
  }

  if (data.candidate) {
    try { await pc.addIceCandidate(data.candidate); } catch(e){}
  }

  chatPartner = from;
  chatUI.style.display = "block";
  chatWith.innerText = "Chat with: " + from;

  loadOldMessages(from);
};



/* SEND / RECEIVE */
function sendMsg() {
  let text = msg.value.trim();
  if (!text) return;

  channel.send(text);
  saveMessage(chatPartner, text, true);

  let div = document.createElement("div");
  div.className="msg me";
  div.innerText = "Me: " + text;
  messages.appendChild(div);

  msg.value = "";
  messages.scrollTop = messages.scrollHeight;
}

function receiveMsg(text) {
  saveMessage(chatPartner, text, false);

  let div = document.createElement("div");
  div.className="msg";
  div.innerText = chatPartner + ": " + text;
  messages.appendChild(div);

  messages.scrollTop = messages.scrollHeight;
}

</script>

</body>
        </html> 
