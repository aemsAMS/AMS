<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TikTok Chat Online</title>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Vazirmatn',sans-serif;background:#f0f2f5;color:#333;}
.hidden{display:none;}
.container{max-width:1000px;margin:0 auto;padding:10px;}
#auth{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;}
#auth input{width:100%;max-width:300px;padding:10px;margin:5px 0;border:1px solid #ccc;border-radius:5px;}
#auth button{padding:10px 20px;margin:5px;border:none;background:#ff2e63;color:white;border-radius:5px;cursor:pointer;}
#tabs{display:flex;border-bottom:1px solid #ccc;}
#tabs button{flex:1;padding:15px;background:#fff;border:none;font-weight:bold;cursor:pointer;}
#tabs button.active{background:#ff2e63;color:white;}
#content{display:flex;flex-direction:column;height:90vh;}
#video-section,#chat-section{flex:1;overflow-y:auto;padding:10px;}
.video-item{margin-bottom:20px;}
.video-item iframe{width:100%;height:300px;border-radius:10px;}
#chat-box{flex:1;overflow-y:auto;padding:10px;border:1px solid #ccc;border-radius:10px;margin-bottom:10px;background:#f0f0f0;}
.message{margin-bottom:10px;padding:8px 10px;border-radius:10px;max-width:70%;word-wrap:break-word;}
.message.sent{background:#08d9d6;color:white;margin-left:auto;}
.message.received{background:#ff2e63;color:white;margin-right:auto;}
#chat-input{display:flex;}
#chat-input input{flex:1;padding:10px;border-radius:5px;border:1px solid #ccc;}
#chat-input button{padding:10px 15px;margin-left:5px;border:none;border-radius:5px;background:#ff2e63;color:white;cursor:pointer;}
#user-list{display:flex;overflow-x:auto;margin-bottom:10px;}
#user-list div{padding:10px 15px;background:#ff2e63;color:white;border-radius:20px;margin-right:10px;cursor:pointer;white-space:nowrap;}
#user-list div:hover{background:#ff1b45;}
</style>
</head>
<body>

<!-- Auth -->
<div id="auth">
  <h2>TikTok Chat Online</h2>
  <input type="text" id="username" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ">
  <input type="password" id="password" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
  <div>
    <button id="registerBtn">Ø«Ø¨Øª Ù†Ø§Ù…</button>
    <button id="loginBtn">ÙˆØ±ÙˆØ¯</button>
  </div>
  <p id="auth-msg"></p>
</div>

<!-- Main -->
<div id="main" class="hidden">
  <div id="tabs">
    <button id="tab-videos" class="active">ØªÙ…Ø§Ø´Ø§ÛŒ ÙˆÛŒØ¯Ø¦Ùˆ</button>
    <button id="tab-chat">Ú†Øª</button>
  </div>
  <div id="content">
    <!-- Video Section -->
    <div id="video-section"></div>

    <!-- Chat Section -->
    <div id="chat-section" class="hidden">
      <div id="user-list"></div>
      <div id="chat-box"></div>
      <div id="chat-input">
        <input type="text" id="msgInput" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯">
        <button id="sendMsgBtn">Ø§Ø±Ø³Ø§Ù„</button>
        <button id="sendImgBtn">ðŸ“·</button>
        <button id="sendAudioBtn">ðŸŽ¤</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
  // Firebase Config Ø´Ù…Ø§
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
  import { getDatabase, ref, set, push, onChildAdded, onValue } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDn86gjV3Ena3Q4i84rCGNnnGTyDqEE2Xg",
    authDomain: "ams1-949e7.firebaseapp.com",
    databaseURL: "https://ams1-949e7-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "ams1-949e7",
    storageBucket: "ams1-949e7.firebasestorage.app",
    messagingSenderId: "1061973812134",
    appId: "1:1061973812134:web:94e44e9931b5ae9f3d2567",
    measurementId: "G-HDJ81BTE70"
  };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const auth = getAuth();
  const db = getDatabase();

  const authDiv = document.getElementById("auth");
  const mainDiv = document.getElementById("main");
  const authMsg = document.getElementById("auth-msg");
  const usernameInput = document.getElementById("username");
  const passwordInput = document.getElementById("password");

  // Ø«Ø¨Øª Ù†Ø§Ù…
  document.getElementById("registerBtn").onclick = () => {
    const email = usernameInput.value.trim()+"@fake.com"; // Firebase Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø§ÛŒÙ…ÛŒÙ„ Ø¯Ø§Ø±Ø¯
    const password = passwordInput.value.trim();
    if(!usernameInput.value || !password) { authMsg.textContent="Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯"; return;}
    createUserWithEmailAndPassword(auth,email,password)
    .then(userCredential => { authMsg.style.color="green"; authMsg.textContent="Ø«Ø¨Øª Ù†Ø§Ù… Ù…ÙˆÙÙ‚! ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯"; })
    .catch(error => { authMsg.style.color="red"; authMsg.textContent=error.message; });
  };

  // ÙˆØ±ÙˆØ¯
  document.getElementById("loginBtn").onclick = () => {
    const email = usernameInput.value.trim()+"@fake.com";
    const password = passwordInput.value.trim();
    signInWithEmailAndPassword(auth,email,password)
    .catch(error => { authMsg.style.color="red"; authMsg.textContent=error.message; });
  };

  // Ù…Ø§Ù†ÛŒØªÙˆØ± ÙˆØ±ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø±
  let currentUser = null;
  onAuthStateChanged(auth,user=>{
    if(user){
      currentUser = user.uid;
      authDiv.classList.add("hidden");
      mainDiv.classList.remove("hidden");
      loadUsersList();
      loadVideos();
    } else {
      authDiv.classList.remove("hidden");
      mainDiv.classList.add("hidden");
    }
  });

  // Tabs
  const tabVideos=document.getElementById("tab-videos");
  const tabChat=document.getElementById("tab-chat");
  const videoSection=document.getElementById("video-section");
  const chatSection=document.getElementById("chat-section");

  tabVideos.onclick=()=>{ tabVideos.classList.add("active"); tabChat.classList.remove("active"); videoSection.style.display="block"; chatSection.style.display="none"; };
  tabChat.onclick=()=>{ tabChat.classList.add("active"); tabVideos.classList.remove("active"); chatSection.style.display="flex"; videoSection.style.display="none"; };

  // ÙˆÛŒØ¯Ø¦Ùˆ TikTok Ù†Ù…ÙˆÙ†Ù‡
  const videos = [
    "https://www.tiktok.com/embed/7255031982033485099",
    "https://www.tiktok.com/embed/7245678912345678901"
  ];

  function loadVideos(){
    videoSection.innerHTML="";
    videos.forEach(link=>{
      const div = document.createElement("div"); div.className="video-item";
      div.innerHTML=`<iframe src="${link}" frameborder="0" allowfullscreen></iframe>`;
      videoSection.appendChild(div);
    });
  }

  // Chat
  const userListDiv=document.getElementById("user-list");
  const chatBox=document.getElementById("chat-box");
  const msgInput=document.getElementById("msgInput");
  const sendMsgBtn=document.getElementById("sendMsgBtn");
  const sendImgBtn=document.getElementById("sendImgBtn");
  const sendAudioBtn=document.getElementById("sendAudioBtn");
  let currentChatUser=null;

  function loadUsersList(){
    userListDiv.innerHTML="";
    const usersRef = ref(db,"users");
    onValue(usersRef,snapshot=>{
      userListDiv.innerHTML="";
      snapshot.forEach(u=>{
        if(u.key===currentUser) return;
        const div=document.createElement("div");
        div.textContent=u.key;
        div.onclick=()=>{
          currentChatUser=u.key;
          chatBox.innerHTML="";
          listenChat(currentUser,currentChatUser);
        };
        userListDiv.appendChild(div);
      });
    });
    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø®ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ Ù„ÛŒØ³Øª Firebase
    set(ref(db,"users/"+currentUser),{online:true});
  }

  function listenChat(uid1,uid2){
    chatBox.innerHTML="";
    const chatId = [uid1,uid2].sort().join("_");
    const messagesRef = ref(db,"chats/"+chatId);
    onChildAdded(messagesRef,snapshot=>{
      const msg = snapshot.val();
      const div = document.createElement("div");
      div.className = "message "+(msg.sender===currentUser?"sent":"received");
      if(msg.type==="text") div.textContent = msg.content;
      if(msg.type==="image") div.innerHTML = `<img src="${msg.content}" style="max-width:100%;border-radius:10px;">`;
      if(msg.type==="audio") div.innerHTML = `<audio controls src="${msg.content}" style="width:100%;margin-top:5px;"></audio>`;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    });
  }

  function sendMessage(type,content){
    if(!currentChatUser) return alert("ÛŒÚ© Ú©Ø§Ø±Ø¨Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯");
    const chatId = [currentUser,currentChatUser].sort().join("_");
    const newMsgRef = push(ref(db,"chats/"+chatId));
    set(newMsgRef,{sender:currentUser,type,content});
  }

  sendMsgBtn.onclick=()=>{ const val=msgInput.value.trim(); if(val) sendMessage("text",val); msgInput.value=""; };
  
  sendImgBtn.onclick=()=>{
    const fileInput=document.createElement("input"); fileInput.type="file"; fileInput.accept="image/*";
    fileInput.onchange=()=>{
      const file=fileInput.files[0]; if(!file) return;
      const reader=new FileReader();
      reader.onload=()=>{ sendMessage("image",reader.result); };
      reader.readAsDataURL(file);
    };
    fileInput.click();
  };

  sendAudioBtn.onclick=()=>{
    if(!navigator.mediaDevices || !window.MediaRecorder){ alert("Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² Ø¶Ø¨Ø· ØµØ¯Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯"); return; }
    navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
      const mediaRecorder = new MediaRecorder(stream);
      let chunks = [];
      mediaRecorder.ondataavailable = e=>{ chunks.push(e.data); };
      mediaRecorder.onstop = ()=>{
        const blob = new Blob(chunks,{type:'audio/webm'});
        const url = URL.createObjectURL(blob);
        sendMessage("audio",url);
        chunks=[];
      };
      mediaRecorder.start();
      alert("Ø¶Ø¨Ø· Ø¢ØºØ§Ø² Ø´Ø¯. Ù¾Ø³ Ø§Ø² Ù¾Ø§ÛŒØ§Ù†ØŒ OK Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.");
      setTimeout(()=>{ mediaRecorder.stop(); stream.getTracks().forEach(t=>t.stop()); },5000);
    });
  };

</script>
</body>
  </html> 
