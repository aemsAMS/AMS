<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>TikChat â€” Minimal</title>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  /* ===== Reset & base ===== */
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:'Vazirmatn',system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial; background:#eceff1; color:#111}
  a{color:inherit}
  button{cursor:pointer}

  /* ===== App layout: full-screen sections ===== */
  #app{height:100vh;display:flex;flex-direction:column}
  header.topbar{height:56px;display:flex;align-items:center;justify-content:space-between;padding:0 14px;background:#f5f7f8;border-bottom:1px solid #e0e0e0}
  header.topbar .brand{font-weight:600}
  main.view{flex:1;position:relative;overflow:hidden}

  /* bottom nav */
  nav.bottom{height:56px;display:flex;border-top:1px solid #e0e0e0;background:#f5f7f8}
  nav.bottom button{flex:1;border:0;background:transparent;font-weight:600}

  /* Fullscreen sections */
  .section{position:absolute;inset:56px 0 56px 0;display:none;overflow:auto;background:transparent;padding:10px}
  .section.active{display:block}

  /* ===== Feed - each item full viewport (snap) ===== */
  .feed{height:100%;width:100%;overflow-y:auto;scroll-snap-type:y mandatory;-webkit-overflow-scrolling:touch}
  .card{height:calc(100vh - 56px - 56px - 20px); /* header + nav + padding */ width:100%;scroll-snap-align:start;display:flex;align-items:center;justify-content:center;border-radius:8px;overflow:hidden;background:#000}
  .card iframe{width:100%;height:100%;border:0}
  .card .overlay{position:absolute;left:12px;bottom:12px;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,0.5)}

  /* simple right side small actions (minimal) */
  .side{position:absolute;right:12px;bottom:70px;display:flex;flex-direction:column;gap:10px}
  .side button{width:44px;height:44px;border-radius:10px;border:0;background:rgba(255,255,255,0.06);color:#fff}

  /* ===== Chat UI simple ===== */
  .chat-container{display:flex;flex-direction:column;height:100%}
  .search-row{display:flex;gap:8px;margin-bottom:8px}
  .search-row input{flex:1;padding:10px;border-radius:8px;border:1px solid #ddd;background:#fff}
  .users-row{display:flex;gap:8px;overflow:auto;padding-bottom:8px;margin-bottom:8px}
  .user-pill{padding:8px 12px;border-radius:20px;background:#fff;border:1px solid #ddd;white-space:nowrap;cursor:pointer}
  .messages{flex:1;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:8px}
  .msg{max-width:72%;padding:8px;border-radius:10px;background:#fff;border:1px solid #e0e0e0}
  .msg.me{margin-left:auto;background:#b2dfdb}
  .composer{display:flex;gap:8px;padding-top:8px}
  .composer input[type="text"]{flex:1;padding:10px;border-radius:8px;border:1px solid #ddd;background:#fff}

  /* manage UI */
  .manage-controls{display:flex;gap:8px;margin-bottom:10px}
  .manage-controls input{flex:1;padding:10px;border-radius:8px;border:1px solid #ddd;background:#fff}

  /* small screens adjustments */
  @media(max-width:600px){
    .card{height:calc(100vh - 56px - 56px - 28px)}
  }
</style>
</head>
<body>
<div id="app">
  <header class="topbar">
    <div class="brand">TikChat (Minimal)</div>
    <div id="badge" style="font-size:14px;color:#666"></div>
  </header>

  <main class="view">
    <!-- Feed section -->
    <section id="home" class="section active" aria-label="feed">
      <div id="feed" class="feed" tabindex="0"></div>
    </section>

    <!-- Chat section -->
    <section id="chat" class="section" aria-label="chat">
      <div class="chat-container">
        <div class="search-row">
          <input id="searchUser" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ Ø¨Ù†ÙˆÛŒØ³ Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯..." />
          <button id="startChatBtn">Ø´Ø±ÙˆØ¹</button>
        </div>
        <div id="usersRow" class="users-row"></div>
        <div id="messages" class="messages"></div>
        <div class="composer">
          <input id="textMsg" type="text" placeholder="Ù¾ÛŒØ§Ù…..." />
          <button id="sendText">Ø§Ø±Ø³Ø§Ù„</button>
          <button id="attachImg">ğŸ“·</button>
          <button id="recAudio">ğŸ¤</button>
        </div>
      </div>
    </section>

    <!-- Manage section -->
    <section id="manage" class="section" aria-label="manage">
      <div>
        <div class="manage-controls">
          <input id="videoInput" placeholder="Ù„ÛŒÙ†Ú© TikTok (embed ÛŒØ§ Ù…Ø¹Ù…ÙˆÙ„ÛŒ)" />
          <button id="addVideo">Ø§ÙØ²ÙˆØ¯Ù†</button>
          <button id="clearVideos">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡</button>
        </div>
        <div id="manageList"></div>
      </div>
    </section>
  </main>

  <nav class="bottom" role="navigation" aria-label="main nav">
    <button id="btnHome">Ø®Ø§Ù†Ù‡</button>
    <button id="btnChat">Ú†Øª</button>
    <button id="btnManage">Ù…Ø¯ÛŒØ±ÛŒØª</button>
  </nav>
</div>

<script>
/* ===== Keys ===== */
const USERS_KEY = 'tc_min_users_v1';
const CHATS_KEY = 'tc_min_chats_v1';
const VIDEOS_KEY = 'tc_min_videos_v1';

/* ===== Utilities ===== */
function load(key, fallback){ try{ return JSON.parse(localStorage.getItem(key)) || fallback; }catch(e){ return fallback; } }
function save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
function uid(){ return Math.random().toString(36).slice(2,9); }

/* ===== Initial data if empty ===== */
if(!localStorage.getItem(USERS_KEY)){
  const sample = { 'alice':'123', 'bob':'123' };
  save(USERS_KEY, sample);
}
if(!localStorage.getItem(VIDEOS_KEY)){
  save(VIDEOS_KEY, [
    // sample embed links â€” these may or may not exist; you can add your own links
    'https://www.tiktok.com/embed/7163153089386168838',
    'https://www.tiktok.com/embed/7183459084386578434'
  ]);
}
if(!localStorage.getItem(CHATS_KEY)) save(CHATS_KEY, {});

/* ===== App State ===== */
let state = {
  currentUser: null,
  currentTarget: null,
  videosLoaded: 0,
  perLoad: 1
};

/* ===== Simple auth flow (prompt-based, minimal UI) ===== */
async function authFlow(){
  // try to ask username/password using simple prompts to keep UI minimal
  while(true){
    const username = prompt('Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ø§Ù„: alice)').trim();
    if(!username) continue;
    const users = load(USERS_KEY, {});
    if(users[username]){
      const pass = prompt('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:');
      if(pass === users[username]){ state.currentUser = username; break; }
      else { alert('Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡'); continue; }
    } else {
      if(confirm('Ú©Ø§Ø±Ø¨Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ â€” Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¨Ø³Ø§Ø²ÛŒØ¯ØŸ')){
        const pass = prompt('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¬Ø¯ÛŒØ¯:') || '';
        users[username] = pass;
        save(USERS_KEY, users);
        state.currentUser = username;
        break;
      } else continue;
    }
  }
  document.getElementById('badge').textContent = state.currentUser;
  initAfterAuth();
}

/* ===== Section navigation ===== */
const homeSec = document.getElementById('home');
const chatSec = document.getElementById('chat');
const manageSec = document.getElementById('manage');
function show(section){
  [homeSec,chatSec,manageSec].forEach(s=>s.classList.remove('active'));
  section.classList.add('active');
}
document.getElementById('btnHome').onclick = ()=>show(homeSec);
document.getElementById('btnChat').onclick = ()=>{ show(chatSec); renderUsers(); renderMessages(); };
document.getElementById('btnManage').onclick = ()=>{ show(manageSec); renderManage(); };

/* ===== Convert link to embed ===== */
function toEmbed(url){
  if(!url) return url;
  url = url.trim();
  if(url.includes('/embed/')) return url;
  const m = url.match(/\/video\/(\d+)/);
  if(m) return 'https://www.tiktok.com/embed/' + m[1];
  // if short link (vm.tiktok...), cannot resolve without server â€” return as-is (may not embed)
  return url;
}

/* ===== Feed rendering & infinite load ===== */
const feedEl = document.getElementById('feed');
function loadMore(){
  const videos = load(VIDEOS_KEY, []);
  if(state.videosLoaded >= videos.length) return;
  const to = Math.min(state.videosLoaded + state.perLoad, videos.length);
  for(let i=state.videosLoaded;i<to;i++){
    const v = videos[i];
    const card = document.createElement('div'); card.className='card';
    const iframe = document.createElement('iframe'); iframe.src = v; iframe.loading='lazy'; iframe.allow='autoplay; fullscreen';
    card.appendChild(iframe);
    const overlay = document.createElement('div'); overlay.className='overlay'; overlay.innerText = `ÙˆÛŒØ¯Ø¦Ùˆ ${i+1}`;
    card.appendChild(overlay);
    const side = document.createElement('div'); side.className='side';
    const sendBtn = document.createElement('button'); sendBtn.textContent='âœ‰'; sendBtn.title='Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ú†Øª';
    sendBtn.onclick = ()=>{ if(!state.currentTarget){ alert('Ø§Ø¨ØªØ¯Ø§ Ø¯Ø± Ø¨Ø®Ø´ Ú†Øª ÛŒÚ© Ú©Ø§Ø±Ø¨Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†'); show(chatSec); return; } sendToChat(state.currentTarget, `[TikTok Video](${v})`); show(chatSec); renderMessages(); };
    side.appendChild(sendBtn);
    card.appendChild(side);
    feedEl.appendChild(card);
  }
  state.videosLoaded = to;
}
feedEl.addEventListener('scroll', ()=>{ if(feedEl.scrollTop + feedEl.clientHeight >= feedEl.scrollHeight - 60) loadMore(); });

/* ===== Manage: add/clear/render ===== */
document.getElementById('addVideo').onclick = ()=>{
  const raw = document.getElementById('videoInput').value.trim();
  if(!raw){ alert('Ù„ÛŒÙ†Ú© ÙˆØ§Ø±Ø¯ Ú©Ù†'); return; }
  const embed = toEmbed(raw);
  const arr = load(VIDEOS_KEY, []);
  arr.unshift(embed); // newest first
  save(VIDEOS_KEY, arr);
  document.getElementById('videoInput').value='';
  // reset feed and reload
  feedEl.innerHTML = '';
  state.videosLoaded = 0;
  loadMore();
  renderManage();
};
document.getElementById('clearVideos').onclick = ()=>{
  if(confirm('Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡ ÙˆÛŒØ¯Ø¦ÙˆÙ‡Ø§ØŸ')){ save(VIDEOS_KEY, []); feedEl.innerHTML=''; state.videosLoaded=0; renderManage(); }
};
function renderManage(){
  const list = document.getElementById('manageList'); list.innerHTML='';
  const videos = load(VIDEOS_KEY, []);
  videos.forEach((v,idx)=>{
    const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='8px'; row.style.marginBottom='6px'; row.style.background='#fff'; row.style.border='1px solid #eee'; row.style.borderRadius='8px';
    const left = document.createElement('div'); left.style.maxWidth='80%'; left.style.overflow='hidden'; left.style.textOverflow='ellipsis'; left.textContent = v;
    const rm = document.createElement('button'); rm.textContent='Ø­Ø°Ù'; rm.onclick = ()=>{ videos.splice(idx,1); save(VIDEOS_KEY,videos); renderManage(); feedEl.innerHTML=''; state.videosLoaded=0; loadMore(); };
    row.appendChild(left); row.appendChild(rm); list.appendChild(row);
  });
}

/* ===== Chat: users, messages, send/attach/record ===== */
function renderUsers(filter=''){
  const wr = document.getElementById('usersRow'); wr.innerHTML='';
  const users = load(USERS_KEY, {});
  Object.keys(users).forEach(u=>{
    if(u===state.currentUser) return;
    if(filter && !u.includes(filter)) return;
    const pill = document.createElement('div'); pill.className='user-pill'; pill.textContent = u;
    pill.onclick = ()=>{ state.currentTarget = u; renderMessages(); };
    wr.appendChild(pill);
  });
}
document.getElementById('startChatBtn').onclick = ()=>{
  const q = document.getElementById('searchUser').value.trim();
  if(!q){ alert('Ù†Ø§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†'); return; }
  const users = load(USERS_KEY, {});
  if(!users[q]){ if(confirm('Ú©Ø§Ø±Ø¨Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ â€” Ø§ÛŒØ¬Ø§Ø¯ Ø´ÙˆØ¯ØŸ')){ users[q]=''; save(USERS_KEY, users); } else return; }
  renderUsers(q);
};
/* Messages store helpers */
function chatKey(a,b){ return [a,b].sort().join('__'); }
function loadChats(){ return load(CHATS_KEY, {}); }
function saveChats(obj){ save(CHATS_KEY, obj); }
function renderMessages(){
  const box = document.getElementById('messages'); box.innerHTML='';
  if(!state.currentTarget){ box.innerHTML = '<div class="muted">ÛŒÚ© Ú©Ø§Ø±Ø¨Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† ÛŒØ§ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†</div>'; return; }
  const id = chatKey(state.currentUser, state.currentTarget);
  const chats = loadChats(); const arr = chats[id] || [];
  arr.forEach(m=>{
    const d = document.createElement('div'); d.className = 'msg ' + (m.sender===state.currentUser ? 'me' : '');
    let html = m.text
      .replace(/\[TikTok Video\]\((.*?)\)/g, '<iframe src="$1" allowfullscreen style="width:100%;height:380px;border:0;border-radius:8px"></iframe>')
      .replace(/\[Image\]\((.*?)\)/g, '<img src="$1" style="max-width:100%;border-radius:8px">')
      .replace(/\[Audio\]\((.*?)\)/g, '<audio controls src="$1" style="width:100%"></audio>');
    d.innerHTML = html;
    box.appendChild(d);
  });
  box.scrollTop = box.scrollHeight;
}
function sendToChat(target, text){
  if(!target){ alert('Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ù…Ø®Ø§Ø·Ø¨ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†'); return; }
  const chats = loadChats();
  const k = chatKey(state.currentUser, target);
  chats[k] = chats[k] || [];
  chats[k].push({sender: state.currentUser, text, time: Date.now()});
  saveChats(chats);
  if(state.currentTarget === target) renderMessages();
}
/* send text */
document.getElementById('sendText').onclick = ()=>{
  const t = document.getElementById('textMsg').value.trim();
  if(!t) return;
  if(!state.currentTarget){ alert('Ø§Ø¨ØªØ¯Ø§ Ù…Ø®Ø§Ø·Ø¨ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†'); return; }
  sendToChat(state.currentTarget, t);
  document.getElementById('textMsg').value='';
};
/* attach image */
document.getElementById('attachImg').onclick = ()=>{
  if(!state.currentTarget){ alert('Ø§Ø¨ØªØ¯Ø§ Ù…Ø®Ø§Ø·Ø¨ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†'); return; }
  const f = document.createElement('input'); f.type='file'; f.accept='image/*'; f.onchange = ()=>{
    const file = f.files[0]; if(!file) return;
    const r = new FileReader();
    r.onload = ()=> sendToChat(state.currentTarget, `[Image](${r.result})`);
    r.readAsDataURL(file);
  }; f.click();
};

/* record audio â€” convert blob to dataURL and store (persist across reloads) */
document.getElementById('recAudio').onclick = async ()=>{
  if(!state.currentTarget){ alert('Ø§Ø¨ØªØ¯Ø§ Ù…Ø®Ø§Ø·Ø¨ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†'); return; }
  if(!navigator.mediaDevices || !window.MediaRecorder){ alert('Ø¶Ø¨Ø· ØµØ¯Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯ (Ù†ÛŒØ§Ø² Ø¨Ù‡ HTTPS ÛŒØ§ Ù…Ø±ÙˆØ±Ú¯Ø± Ù…Ø¯Ø±Ù†)'); return; }
  try{
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    const recorder = new MediaRecorder(stream);
    const chunks = [];
    recorder.ondataavailable = e => chunks.push(e.data);
    recorder.onstop = async () => {
      const blob = new Blob(chunks,{type:'audio/webm'});
      // convert blob -> dataURL to persist in localStorage
      const reader = new FileReader();
      reader.onload = ()=> {
        const dataUrl = reader.result;
        sendToChat(state.currentTarget, `[Audio](${dataUrl})`);
      };
      reader.readAsDataURL(blob);
      stream.getTracks().forEach(t=>t.stop());
    };
    recorder.start();
    alert('Ø¶Ø¨Ø· Ø¢ØºØ§Ø² Ø´Ø¯ â€” Ø¨Ø¹Ø¯ Ø§Ø² Ù¾Ø§ÛŒØ§Ù† Ø±ÙˆÛŒ OK Ú©Ù„ÛŒÚ© Ú©Ù† ÛŒØ§ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø¹Ø¯ Ø§Ø² 6 Ø«Ø§Ù†ÛŒÙ‡ Ù…ØªÙˆÙ‚Ù Ù…ÛŒâ€ŒØ´ÙˆØ¯.');
    // auto stop after 6s to avoid too large blobs
    setTimeout(()=>{ if(recorder.state === 'recording') recorder.stop(); }, 6000);
  } catch(err){
    alert('Ø¯Ø³ØªØ±Ø³ÛŒ Ø¶Ø¨Ø· ØµØ¯Ø§ Ø±Ø¯ Ø´Ø¯ ÛŒØ§ Ø®Ø·Ø§: ' + err.message);
  }
};

/* ===== Render users & init after auth ===== */
function initAfterAuth(){
  document.getElementById('badge').textContent = state.currentUser;
  // prepare feed
  feedEl.innerHTML = '';
  state.videosLoaded = 0;
  loadMore();
}
function renderUsers(){ renderUsersList(); renderMessages(); }
function renderUsersList(){
  const q = document.getElementById('searchUser').value.trim();
  const wr = document.getElementById('usersRow'); wr.innerHTML='';
  const users = load(USERS_KEY, {});
  Object.keys(users).forEach(u=>{
    if(u===state.currentUser) return;
    if(q && !u.includes(q)) return;
    const pill = document.createElement('div'); pill.className='user-pill'; pill.textContent=u;
    pill.onclick = ()=>{ state.currentTarget = u; renderMessages(); };
    wr.appendChild(pill);
  });
}

/* when opening chat tab, update user list reactively */
document.getElementById('searchUser').addEventListener('input', ()=> renderUsersList());

/* ===== start ===== */
authFlow();
</script>
</body>
  </html> 
