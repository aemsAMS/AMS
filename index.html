<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TikTok Chat Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Vazirmatn',sans-serif;background:#f0f2f5;color:#333;}
.hidden{display:none;}
.container{max-width:1000px;margin:0 auto;padding:10px;}

/* Auth */
#auth{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;transition:all 0.3s;}
#auth h2{margin-bottom:20px;}
#auth input{width:100%;max-width:300px;padding:10px;margin:5px 0;border:1px solid #ccc;border-radius:5px;}
#auth button{padding:10px 20px;margin:10px;border:none;background:#ff2e63;color:white;border-radius:5px;transition:0.3s;}
#auth button:hover{background:#ff1b45;}
#auth-msg{margin-top:10px;color:red;}

/* Tabs */
#main{display:flex;flex-direction:column;height:100vh;}
#tabs{display:flex;border-bottom:1px solid #ccc;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
#tabs button{flex:1;padding:15px;background:#fff;border:none;font-weight:bold;transition:0.3s;}
#tabs button.active{background:#ff2e63;color:white;}
#content{flex:1;display:flex;overflow:hidden;transition:all 0.3s;}

/* Video Section */
#video-section{flex:1;padding:10px;overflow-y:auto;background:#fff;border-right:1px solid #ccc;transition:all 0.3s;}
.video-item{margin-bottom:20px;position:relative;transition:0.3s;}
.video-item iframe{width:100%;height:300px;border-radius:10px;}
.video-item button.send-link{position:absolute;bottom:10px;right:10px;padding:5px 10px;background:#08d9d6;color:white;border:none;border-radius:5px;transition:0.3s;}
.video-item button.send-link:hover{background:#06c0b0;}

/* Chat Section */
#chat-section{flex:1;padding:10px;display:flex;flex-direction:column;background:#fefefe;transition:all 0.3s;}
#search-user{margin-bottom:10px;}
#search-user input{width:100%;padding:8px;border-radius:5px;border:1px solid #ccc;}
#user-list{flex:0 0 100px;overflow-x:auto;display:flex;margin-bottom:10px;}
#user-list div{padding:10px 15px;background:#ff2e63;color:white;border-radius:20px;margin-right:10px;white-space:nowrap;cursor:pointer;transition:0.3s;}
#user-list div:hover{background:#ff1b45;}
#chat-box{flex:1;overflow-y:auto;padding:10px;border:1px solid #ccc;border-radius:10px;margin-bottom:10px;background:#f0f0f0;transition:0.3s;}
.message{margin-bottom:10px;padding:8px 10px;border-radius:10px;max-width:70%;word-wrap:break-word;transition:0.3s;}
.message.sent{background:#08d9d6;color:white;margin-left:auto;animation:fadeIn 0.3s;}
.message.received{background:#ff2e63;color:white;margin-right:auto;animation:fadeIn 0.3s;}
#chat-input{display:flex;}
#chat-input input{flex:1;padding:10px;border-radius:5px;border:1px solid #ccc;}
#chat-input button{padding:10px 15px;margin-left:5px;border:none;border-radius:5px;background:#ff2e63;color:white;transition:0.3s;}
#chat-input button:hover{background:#ff1b45;}

/* Management */
#manage-section{flex:1;padding:10px;display:flex;flex-direction:column;background:#fff;transition:all 0.3s;}
#manage-section input{padding:10px;border-radius:5px;border:1px solid #ccc;margin-bottom:10px;}
#manage-section button{padding:10px 15px;border:none;border-radius:5px;background:#08d9d6;color:white;margin-bottom:10px;}
#manage-section button:hover{background:#06c0b0;}
#manage-list div{margin-bottom:10px;padding:8px;background:#f0f0f0;border-radius:5px;}

/* Animations */
@keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}

/* Responsive */
@media(max-width:768px){
  #content{flex-direction:column;}
  #video-section,#chat-section,#manage-section{flex:1;height:50vh;border-right:none;}
  #user-list{flex-wrap:wrap;}
}
</style>
</head>
<body>

<!-- Auth -->
<div id="auth">
  <h2>TikTok Chat Pro</h2>
  <input type="text" id="username" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ">
  <input type="password" id="password" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
  <div>
    <button id="registerBtn">Ø«Ø¨Øª Ù†Ø§Ù…</button>
    <button id="loginBtn">ÙˆØ±ÙˆØ¯</button>
  </div>
  <p id="auth-msg"></p>
</div>

<!-- Main -->
<div id="main" class="hidden">
  <div id="tabs">
    <button id="tab-videos" class="active">ØªÙ…Ø§Ø´Ø§ÛŒ ÙˆÛŒØ¯Ø¦Ùˆ</button>
    <button id="tab-chat">Ú†Øª</button>
    <button id="tab-manage">Ù…Ø¯ÛŒØ±ÛŒØª ÙˆÛŒØ¯Ø¦Ùˆ</button>
  </div>

  <div id="content">
    <!-- Video Section -->
    <div id="video-section"></div>

    <!-- Chat Section -->
    <div id="chat-section" class="hidden">
      <div id="search-user">
        <input type="text" id="searchInput" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©Ø§Ø±Ø¨Ø±...">
      </div>
      <div id="user-list"></div>
      <div id="chat-box"></div>
      <div id="chat-input">
        <input type="text" id="msgInput" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯">
        <button id="sendMsgBtn">Ø§Ø±Ø³Ø§Ù„</button>
        <button id="sendImgBtn">ğŸ“·</button>
        <button id="sendAudioBtn">ğŸ¤</button>
      </div>
    </div>

    <!-- Manage Section -->
    <div id="manage-section" class="hidden">
      <input type="text" id="videoLinkInput" placeholder="Ù„ÛŒÙ†Ú© ÙˆÛŒØ¯Ø¦Ùˆ TikTok">
      <button id="addVideoBtn">Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙˆÛŒØ¯Ø¦Ùˆ</button>
      <button id="clearVideosBtn">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡ ÙˆÛŒØ¯Ø¦ÙˆÙ‡Ø§</button>
      <div id="manage-list"></div>
    </div>
  </div>
</div>

<script>
/* ===== LocalStorage Helpers ===== */
const USERS_KEY = "ttchat_users_adv";
const CHATS_KEY = "ttchat_chats_adv";
const VIDEOS_KEY = "ttchat_videos_adv";
let currentUser = null;
let currentChatUser = null;

/* ===== Auth Functions ===== */
function loadUsers(){ return JSON.parse(localStorage.getItem(USERS_KEY)||"{}"); }
function saveUsers(users){ localStorage.setItem(USERS_KEY, JSON.stringify(users)); }
function loadChats(){ return JSON.parse(localStorage.getItem(CHATS_KEY)||"{}"); }
function saveChats(chats){ localStorage.setItem(CHATS_KEY, JSON.stringify(chats)); }
function loadVideos(){ return JSON.parse(localStorage.getItem(VIDEOS_KEY)||"[]"); }
function saveVideos(videos){ localStorage.setItem(VIDEOS_KEY, JSON.stringify(videos)); }

const authDiv=document.getElementById("auth");
const mainDiv=document.getElementById("main");
const authMsg=document.getElementById("auth-msg");

document.getElementById("registerBtn").onclick=()=>{
  const username=document.getElementById("username").value.trim();
  const password=document.getElementById("password").value.trim();
  if(!username||!password){ authMsg.style.color="red"; authMsg.textContent="Ù„Ø·ÙØ§ Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯"; return;}
  let users=loadUsers();
  if(users[username]){ authMsg.style.color="red"; authMsg.textContent="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª"; return;}
  users[username]={password}; saveUsers(users);
  authMsg.style.color="green"; authMsg.textContent="Ø«Ø¨Øª Ù†Ø§Ù… Ù…ÙˆÙÙ‚ØŒ Ø­Ø§Ù„Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯";
};

document.getElementById("loginBtn").onclick=()=>{
  const username=document.getElementById("username").value.trim();
  const password=document.getElementById("password").value.trim();
  let users=loadUsers();
  if(users[username] && users[username].password===password){
    currentUser=username; authDiv.classList.add("hidden"); mainDiv.classList.remove("hidden"); loadUserList(); loadChat(); loadVideosList(); showTab("videos");
  }else{ authMsg.style.color="red"; authMsg.textContent="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª"; }
};

/* ===== Tabs ===== */
const tabVideos=document.getElementById("tab-videos");
const tabChat=document.getElementById("tab-chat");
const tabManage=document.getElementById("tab-manage");
const videoSection=document.getElementById("video-section");
const chatSection=document.getElementById("chat-section");
const manageSection=document.getElementById("manage-section");

function showTab(tab){
  tabVideos.classList.remove("active"); tabChat.classList.remove("active"); tabManage.classList.remove("active");
  videoSection.style.display="none"; chatSection.style.display="none"; manageSection.style.display="none";
  if(tab==="videos"){ tabVideos.classList.add("active"); videoSection.style.display="block"; }
  if(tab==="chat"){ tabChat.classList.add("active"); chatSection.style.display="flex"; }
  if(tab==="manage"){ tabManage.classList.add("active"); manageSection.style.display="flex"; }
}

tabVideos.onclick=()=>showTab("videos");
tabChat.onclick=()=>showTab("chat");
tabManage.onclick=()=>showTab("manage");

/* ===== Helper: Convert TikTok URL to Embed ===== */
function convertToEmbed(link){
  // Ù…Ø«Ø§Ù„ Ù„ÛŒÙ†Ú© Ù…Ø¹Ù…ÙˆÙ„ÛŒ: https://www.tiktok.com/@username/video/7255031982033485099
  const match = link.match(/\/video\/(\d+)/);
  if(match) return `https://www.tiktok.com/embed/${match[1]}`;
  return link; // Ø§Ú¯Ø± Ù„ÛŒÙ†Ú© ØµØ­ÛŒØ­ Ù†Ø¨ÙˆØ¯ØŒ Ù‡Ù…Ø§Ù† Ø±Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
}

/* ===== Video Management ===== */
const videoLinkInput=document.getElementById("videoLinkInput");
const addVideoBtn=document.getElementById("addVideoBtn");
const clearVideosBtn=document.getElementById("clearVideosBtn");
const manageList=document.getElementById("manage-list");

let videosLoaded=0;

function loadVideosList(){
  const videos=loadVideos();
  videoSection.innerHTML="";
  manageList.innerHTML="";
  videosLoaded = 0;
  loadMoreVideos();
  videos.forEach(link=>{
    const mDiv=document.createElement("div"); mDiv.textContent=link; manageList.appendChild(mDiv);
  });
  document.querySelectorAll(".send-link").forEach(btn=>{
    btn.onclick=()=>{ const idx=btn.getAttribute("data-index"); sendMessage(currentChatUser, `[TikTok Video](${loadVideos()[idx]})`); showTab("chat"); loadChat(); };
  });
}

function loadMoreVideos(){
  const videos=loadVideos();
  const perLoad=3;
  const nextVideos=videos.slice(videosLoaded,videosLoaded+perLoad);
  nextVideos.forEach((link,index)=>{
    const vDiv=document.createElement("div"); vDiv.className="video-item";
    vDiv.innerHTML=`<iframe src="${link}" frameborder="0" allowfullscreen style="width:100%;height:300px;border-radius:10px;"></iframe><button class="send-link" data-index="${videosLoaded+index}">Ø§Ø±Ø³Ø§Ù„ Ø¯Ø± Ú†Øª</button>`;
    videoSection.appendChild(vDiv);
  });
  videosLoaded+=perLoad;
  document.querySelectorAll(".send-link").forEach(btn=>{
    btn.onclick=()=>{ const idx=btn.getAttribute("data-index"); sendMessage(currentChatUser, `[TikTok Video](${loadVideos()[idx]})`); showTab("chat"); loadChat(); };
  });
}

addVideoBtn.onclick=()=>{
  const link=videoLinkInput.value.trim();
  if(!link){ alert("Ù„Ø·ÙØ§ Ù„ÛŒÙ†Ú© ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯"); return; }
  const embedLink = convertToEmbed(link);
  const videos=loadVideos();
  videos.push(embedLink); saveVideos(videos); videoLinkInput.value=""; loadVideosList();
};

clearVideosBtn.onclick=()=>{
  if(confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ù‡Ù…Ù‡ ÙˆÛŒØ¯Ø¦ÙˆÙ‡Ø§ Ø­Ø°Ù Ø´ÙˆÙ†Ø¯ØŸ")){
    saveVideos([]); loadVideosList();
  }
};

/* ===== Chat Functions ===== */
const userListDiv=document.getElementById("user-list");
const chatBox=document.getElementById("chat-box");
const msgInput=document.getElementById("msgInput");
const sendMsgBtn=document.getElementById("sendMsgBtn");
const sendImgBtn=document.getElementById("sendImgBtn");
const sendAudioBtn=document.getElementById("sendAudioBtn");
const searchInput=document.getElementById("searchInput");

function loadUserList(filter=""){
  userListDiv.innerHTML="";
  const users=loadUsers();
  for(let u in users){
    if(u===currentUser) continue;
    if(filter && !u.includes(filter)) continue;
    const div=document.createElement("div"); div.textContent=u;
    div.onclick=()=>{ currentChatUser=u; loadChat(); };
    userListDiv.appendChild(div);
  }
}

function loadChat(){
  chatBox.innerHTML="";
  if(!currentChatUser) return;
  const chats=loadChats();
  const chatId=[currentUser,currentChatUser].sort().join("_");
  const messages=chats[chatId]||[];
  messages.forEach(m=>{
    const div=document.createElement("div");
    div.className="message "+(m.sender===currentUser?"sent":"received");
    let html=m.text.replace(/\[TikTok Video\]\((.*?)\)/g,'<iframe src="$1" frameborder="0" allowfullscreen style="width:100%;height:200px;border-radius:10px;margin-top:5px;"></iframe>')
                 .replace(/\[Image\]\((.*?)\)/g,'<img src="$1" style="max-width:100%;border-radius:10px;margin-top:5px;">')
                 .replace(/\[Audio\]\((.*?)\)/g,'<audio controls src="$1" style="width:100%;margin-top:5px;"></audio>');
    div.innerHTML=html;
    chatBox.appendChild(div);
  });
  chatBox.scrollTop=chatBox.scrollHeight;
}

function sendMessage(to,text){
  if(!to){ alert("Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ú©Ø§Ø±Ø¨Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯"); return; }
  const chats=loadChats();
  const chatId=[currentUser,to].sort().join("_");
  if(!chats[chatId]) chats[chatId]=[];
  chats[chatId].push({sender:currentUser,text});
  saveChats(chats);
  loadChat();
}

sendMsgBtn.onclick=()=>{
  const text=msgInput.value.trim();
  if(text) sendMessage(currentChatUser,text);
  msgInput.value="";
};

sendImgBtn.onclick=()=>{
  const fileInput=document.createElement("input");
  fileInput.type="file"; fileInput.accept="image/*"; fileInput.onchange=()=>{
    const file=fileInput.files[0];
    if(!file) return;
    const reader=new FileReader();
    reader.onload=()=>{ sendMessage(currentChatUser, `[Image](${reader.result})`); };
    reader.readAsDataURL(file);
  };
  fileInput.click();
};

sendAudioBtn.onclick=()=>{
  if(!navigator.mediaDevices || !window.MediaRecorder){ alert("Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² Ø¶Ø¨Ø· ØµØ¯Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯"); return; }
  navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
    const mediaRecorder=new MediaRecorder(stream);
    let chunks=[];
    mediaRecorder.ondataavailable=e=>{ chunks.push(e.data); };
    mediaRecorder.onstop=e=>{
      const blob=new Blob(chunks,{type:'audio/webm'});
      const url=URL.createObjectURL(blob);
      sendMessage(currentChatUser, `[Audio](${url})`);
      chunks=[];
    };
    mediaRecorder.start();
    alert("Ø¶Ø¨Ø· Ø¢ØºØ§Ø² Ø´Ø¯. Ù¾Ø³ Ø§Ø² Ù¾Ø§ÛŒØ§Ù†ØŒ OK Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.");
    setTimeout(()=>{ mediaRecorder.stop(); stream.getTracks().forEach(t=>t.stop()); },5000);
  });
};

/* ===== Search Users ===== */
searchInput.oninput=()=>{ loadUserList(searchInput.value.trim()); };

/* ===== Infinite Scroll for Videos ===== */
videoSection.addEventListener("scroll",()=>{
  if(videoSection.scrollTop + videoSection.clientHeight >= videoSection.scrollHeight - 50){
    loadMoreVideos();
  }
});
</script>
</body>
</html>
